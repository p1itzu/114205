<!DOCTYPE html>
<html lang="zh">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cactus+Classical+Serif&family=Noto+Sans+HK:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap"
        rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{ url_for('static', filename='css/my-order.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/notification.css') }}" rel="stylesheet" />
    <title>ä»£åšèœåª’åˆå¹³å°</title>
</head>

<body>
    <div class="navbar">
        <div class="site-name">å‘³ä½ è€Œç…®</div>
        <div class="nav-links">
            <a href="/AfterLogin">é¦–é </a>
            <a href="/CookingMethod">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="/SearchChef">ç™¼é€è¨‚å–®</a>
            <a href="#">æˆ‘çš„è¨‚å–®</a>
            <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>

        </div>
        <!-- é€šçŸ¥ä¸­å¿ƒè¦–çª— -->
        <div class="notification-center" id="notificationCenter">
            <div class="notification-header">
                <span>é€šçŸ¥ä¸­å¿ƒ</span>
                <button class="clear-all" onclick="clearAllNotifications()">æ¸…ç©ºé€šçŸ¥</button>
            </div>
            <ul class="notification-list" id="notificationList">
                <!-- é€šçŸ¥é …ç›®æœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
            </ul>
        </div>
        <div class="user-info">
            <div class="username">{{ user_email }}</div>
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
        </div>
    </div>
    <br>
    <div class="maintext">æ‰€æœ‰è¨‚å–®</div>
    <div class="filter-buttons">
        <button class="filter-btn active" data-status="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-status="ongoing">é€²è¡Œä¸­</button>
        <button class="filter-btn" data-status="completed">å·²å®Œæˆ</button>
        <button class="filter-btn" data-status="cancelled">å·²å–æ¶ˆ</button>
    </div>
    <div class="container">
        {% if orders %}
            {% for order in orders %}
            {# é è¨­ data-status ç‚º 'all' æˆ–å…¶ä»–é€šç”¨å€¼ï¼Œç„¶å¾Œæ ¹æ“š order.order_status æ›´æ–° #}
                {% set data_status = 'all' %}
                {% if order.order_status in ['ç­‰å¾…å›æ‡‰ä¸­', 'å¾…ä¼°åƒ¹', 'è­°åƒ¹ä¸­-å»šå¸«ä¼°åƒ¹', 'è­°åƒ¹ä¸­-é¡§å®¢å›åƒ¹', 'è­°åƒ¹ä¸­-å»šå¸«å®šåƒ¹', 'å»šå¸«å·²ç¢ºèªï¼Œå‚™é¤ä¸­'] %}
                    {% set data_status = 'ongoing' %}
                {% elif order.order_status in ['é¤é»è£½ä½œå®Œæˆ', 'è¨‚å–®å·²å®Œæˆ'] %}
                    {% set data_status = 'completed' %}
                {% elif order.order_status in ['å·²æ‹’çµ•', 'è¨‚å–®å·²å–æ¶ˆ (é¡§å®¢æœ€çµ‚æ‹’çµ•)'] %}
                    {% set data_status = 'cancelled' %}
                {% endif %}

                <div class="order-card" data-status="{{ data_status }}">
                {# æ ¹æ“š order_status é¡¯ç¤ºä¸åŒçš„æ¨™ç±¤æ¨£å¼å’Œæ–‡å­— #}
                {% if order.order_status == 'è­°åƒ¹ä¸­-å»šå¸«ä¼°åƒ¹' or order.order_status == 'è­°åƒ¹ä¸­-é¡§å®¢å›åƒ¹' or order.order_status == 'è­°åƒ¹ä¸­-å»šå¸«å®šåƒ¹' %}
                    <span class="status-tag-negotiating">è­°åƒ¹ä¸­</span>
                {% elif order.order_status == 'ç­‰å¾…å›æ‡‰ä¸­' %}
                    <span class="status-tag-waiting">ç­‰å¾…å»šå¸«ä¼°åƒ¹</span>
                {% elif order.order_status == 'å¾…ä¼°åƒ¹' %}
                    <span class="status-tag-waiting">å»šå¸«ä¼°åƒ¹ä¸­</span>
                {% elif order.order_status == 'å»šå¸«å·²ç¢ºèªï¼Œå‚™é¤ä¸­' %}
                    <span class="status-tag-making">å‚™é¤ä¸­</span>
                {% elif order.order_status == 'é¤é»è£½ä½œå®Œæˆ' %}
                    <span class="status-tag-completed">é¤é»å®Œæˆ</span>
                {% elif order.order_status == 'è¨‚å–®å·²å®Œæˆ' %}
                    <span class="status-tag-completed">å·²å®Œæˆ</span>
                {% elif order.order_status == 'å·²æ‹’çµ•' %}
                    <span class="status-tag-cancelled">å»šå¸«å·²æ‹’çµ•</span>
                {% elif order.order_status == 'è¨‚å–®å·²å–æ¶ˆ (é¡§å®¢æœ€çµ‚æ‹’çµ•)' %}
                    <span class="status-tag-cancelled">å·²å–æ¶ˆ</span>
                {% else %}
                    <span class="status-tag-default">{{ order.order_status }}</span> {# é è¨­é¡¯ç¤ºç‹€æ…‹ #}
                {% endif %}

                <p class="order-num"><strong>è¨‚å–®ç·¨è™Ÿ</strong><br>#{{ order.order_id }}</p>
                <p>
                    <strong>èœå–®åˆ—è¡¨ï¼š</strong>
                    <br>
                    {% if order.dishes %}
                        {% for dish_name in order.dishes %}
                            {{ loop.index }}. {{ dish_name }}<br>
                        {% endfor %}
                    {% else %}
                        ç„¡èœå“è³‡è¨Š<br>
                    {% endif %}
                </p>
                <div class="button-group">
                    <button class="message-btn" onclick="openMessageBoard(this)">ç•™è¨€</button>
                    {# TODO: ä¹‹å¾Œçš„æŸ¥çœ‹è©³ç´°è¨‚å–®è³‡è¨ŠæŒ‰éˆ•æœƒé€£çµåˆ° route_order_detail #}
                    <a href="{{ url_for('route_order_detail', order_id=order.order_id) }}" class="order-btn">æŸ¥çœ‹è©³ç´°è¨‚å–®è³‡è¨Š</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®ã€‚</p>
        {% endif %}
    </div>

    <!-- ç•™è¨€æ¿å½ˆå‡ºè¦–çª— -->
    <div class="message-modal">
        <div class="message-modal-content">
            <div class="message-modal-header">
                <h3>è¨‚å–®ç•™è¨€</h3>
                <button class="close-message-btn" onclick="closeMessageBoard(this)">&times;</button>
            </div>
            <div class="message-board">
                <div class="message-list">
                    <!-- ç•™è¨€æœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
                </div>
                <div class="message-input">
                    <textarea placeholder="è¼¸å…¥ç•™è¨€..."></textarea>
                    <button class="send-btn">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>
    <!-- è¨­å®šå°è¦–çª— -->
    <div class="settings-modal" id="settings-modal">
        <div class="modal-content">
        <h2 class="title">è¨­å®š</h2>

        <!-- å¸³è™Ÿå€å¡Š -->
        <div class="section2">
            <h3>å¸³è™Ÿ</h3>
            <div class="account-info">
                <img src="{{ url_for('static', filename='imgs/chef.png') }}" alt="Avatar" class="avatar">
                <div class="account-text">
                    <p class="name">{{ username }}</p>
                    <p class="sub-text">å€‹äººè³‡æ–™</p>
                </div>
                <button class="arrow-btn" onclick="toggleProfileModal()">âœ</button>
            </div>
        </div>

        <!-- å…¶ä»– -->
        <div class="section2">
            <h3>å…¶ä»–</h3>
            <button class="logout-btn">
                <span>â†©ï¸ ç™»å‡º</span>
            </button>
            <button class="delete-btn">
                ğŸ—‘ï¸ åˆªé™¤å¸³è™Ÿ
            </button>
        </div>
    </div>
</div>
<!-- ç¬¬äºŒå€‹å€‹äººè³‡æ–™è¦–çª— -->
<div class="settings-modal" id="profile-modal">
    <div class="modal-content profile-content">
        <h2 class="title">å€‹äººè³‡æ–™ç·¨è¼¯</h2>

        <div class="profile-container">
            <!-- é ­åƒå€å¡Š -->
            <div class="avatar-section">
                <img id="profile-avatar" class="profile-avatar" src="{{ url_for('static', filename='imgs/chef.png') }}" alt="å€‹äººé ­åƒ">
                <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                <button class="edit-avatar-btn">å€‹äººé ­åƒç·¨è¼¯</button>
            </div>

            <!-- è¼¸å…¥è¡¨å–® -->
            <div class="form-section">
                <label>å§“åï¼š</label> <input type="text" placeholder="è«‹è¼¸å…¥å§“å">
                <label>é›»å­éƒµä»¶ï¼š</label> <input type="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶">
                <label>é›»è©±ï¼š</label> <input type="tel" placeholder="è«‹è¼¸å…¥é›»è©±">
                <label>å¯†ç¢¼ï¼š</label> <input type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
        </div>

        <!-- å„²å­˜æŒ‰éˆ• -->
        <button class="save-btn">å„²å­˜è®Šæ›´</button>
        <button class="close-btn" onclick="toggleProfileModal()">è¿”å›</button>
        </div>
    </div>
</div>
<script>
    function toggleSettingsModal() {
        const modal = document.getElementById('settings-modal');
        if (modal.style.display === 'flex') {
            modal.style.display = 'none';
        } else {
            modal.style.display = 'flex';
        }
    }

    // å®šç¾© MessageBoard é¡
    class MessageBoard {
        constructor(messageModal) {
            this.messageModal = messageModal;
            this.orderId = messageModal.getAttribute('data-order-id');
            this.messageList = messageModal.querySelector('.message-list');
            this.textarea = messageModal.querySelector('.message-input textarea');
            this.sendBtn = messageModal.querySelector('.message-input .send-btn');
            
            this.messages = this.loadMessages();
            this.initializeEventListeners();
            this.renderMessages();
        }

        loadMessages() {
            const stored = localStorage.getItem(`messages_${this.orderId}`);
            return stored ? JSON.parse(stored) : [];
        }

        saveMessages() {
            localStorage.setItem(`messages_${this.orderId}`, JSON.stringify(this.messages));
        }

        addMessage(content, sender, isCustomer) {
            const message = {
                content,
                sender,
                isCustomer,
                time: new Date().toISOString(),
            };
            this.messages.push(message);
            this.saveMessages();
            this.renderMessage(message);
        }

        renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.isCustomer ? 'customer' : 'chef'}`;
            
            const time = new Date(message.time).toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            messageDiv.innerHTML = `
                <div class="sender">${message.sender}</div>
                <div class="content">${message.content}</div>
                <div class="time">${time}</div>
            `;

            this.messageList.appendChild(messageDiv);
            this.messageList.scrollTop = this.messageList.scrollHeight;
        }

        renderMessages() {
            this.messageList.innerHTML = '';
            this.messages.forEach(message => this.renderMessage(message));
        }

        initializeEventListeners() {
            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
            const newSendBtn = this.sendBtn.cloneNode(true);
            this.sendBtn.parentNode.replaceChild(newSendBtn, this.sendBtn);
            this.sendBtn = newSendBtn;

            const newTextarea = this.textarea.cloneNode(true);
            this.textarea.parentNode.replaceChild(newTextarea, this.textarea);
            this.textarea = newTextarea;

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
            this.sendBtn.addEventListener('click', () => {
                const message = this.textarea.value.trim();
                if (message) {
                    this.addMessage(message, 'é¡§å®¢', true);
                    this.textarea.value = '';
                }
            });

            this.textarea.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendBtn.click();
                }
            });
        }
    }

    // æ‰“é–‹ç•™è¨€æ¿è¦–çª—
    function openMessageBoard(button) {
        const orderCard = button.closest('.order-card');
        const orderId = orderCard.querySelector('.order-num').textContent.split('#')[1].trim();
        const messageModal = document.querySelector('.message-modal');
        
        // è¨­ç½®ç•¶å‰è¨‚å–®IDåˆ°ç•™è¨€æ¿
        messageModal.setAttribute('data-order-id', orderId);
        
        // é¡¯ç¤ºç•™è¨€æ¿è¦–çª—
        messageModal.style.display = 'flex';
        
        // è¼‰å…¥è©²è¨‚å–®çš„ç•™è¨€
        const messageBoard = new MessageBoard(messageModal);
    }

    // é—œé–‰ç•™è¨€æ¿è¦–çª—
    function closeMessageBoard(button) {
        const messageModal = button.closest('.message-modal');
        messageModal.style.display = 'none';
    }

    // æ–°å¢æŒ‰éˆ•åˆ‡æ›åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function () {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const orderCards = document.querySelectorAll('.order-card');

        filterButtons.forEach(button => {
            button.addEventListener('click', function () {
                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
                filterButtons.forEach(btn => btn.classList.remove('active'));
                // ç‚ºè¢«é»æ“Šçš„æŒ‰éˆ•æ·»åŠ  active é¡åˆ¥
                this.classList.add('active');

                // ç²å–é¸ä¸­çš„ç‹€æ…‹
                const selectedStatus = this.getAttribute('data-status');

                // é¡¯ç¤º/éš±è—å°æ‡‰çš„å¡ç‰‡
                orderCards.forEach(card => {
                    if (selectedStatus === 'all' || card.getAttribute('data-status') === selectedStatus) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // é»æ“Šè¦–çª—å¤–é—œé–‰ç•™è¨€æ¿
        document.querySelector('.message-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('message-modal')) {
                closeMessageBoard(e.target.querySelector('.close-message-btn'));
            }
        });

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¨ªå•ï¼Œæ·»åŠ ç¤ºç¯„ç•™è¨€
        document.querySelectorAll('.order-card').forEach(orderCard => {
            const orderId = orderCard.querySelector('.order-num').textContent.split('#')[1].trim();
            const storageKey = `messages_${orderId}`;
            
            if (!localStorage.getItem(storageKey)) {
                const messages = [
                    {
                        content: 'è«‹å•é€™é“èœå¯ä»¥å°‘æ”¾è¾£å—ï¼Ÿ',
                        sender: 'é¡§å®¢',
                        isCustomer: true,
                        time: new Date().toISOString()
                    },
                    {
                        content: 'æ²’å•é¡Œï¼Œæˆ‘æœƒä¾ç…§æ‚¨çš„è¦æ±‚èª¿æ•´ã€‚',
                        sender: 'å»šå¸«',
                        isCustomer: false,
                        time: new Date(Date.now() + 1000).toISOString()
                    }
                ];
                localStorage.setItem(storageKey, JSON.stringify(messages));
            }
        });
    });
     // åˆ‡æ›è¨­å®šè¦–çª—
     function toggleSettingsModal() {
        const modal = document.getElementById('settings-modal');

        if (modal.classList.contains('show')) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // ç­‰å‹•ç•«çµæŸå†éš±è—
        } else {
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
    }

    // åˆ‡æ›å€‹äººè³‡æ–™è¦–çª—
    function toggleProfileModal() {
        const profileModal = document.getElementById('profile-modal');

        if (profileModal.classList.contains('show')) {
            profileModal.classList.remove('show');
            setTimeout(() => {
                profileModal.style.display = 'none';
            }, 300);
        } else {
            profileModal.style.display = 'flex';
            setTimeout(() => {
                profileModal.classList.add('show');
            }, 10);
        }
    }

    // é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰
    window.onclick = function (event) {
        const settingsModal = document.getElementById('settings-modal');
        const profileModal = document.getElementById('profile-modal');

        // å¦‚æœé»æ“Šçš„ç›®æ¨™æ˜¯ `settingsModal` æœ¬èº«ï¼Œå‰‡é—œé–‰å®ƒ
        if (event.target === settingsModal) {
            toggleSettingsModal();
        }

        // å¦‚æœé»æ“Šçš„ç›®æ¨™æ˜¯ `profileModal` æœ¬èº«ï¼Œå‰‡é—œé–‰å®ƒ
        if (event.target === profileModal) {
            toggleProfileModal();
        }
    };

    // è™•ç†é ­åƒä¸Šå‚³
    document.addEventListener("DOMContentLoaded", function () {
        const avatarInput = document.getElementById("avatar-input");
        const profileAvatar = document.getElementById("profile-avatar");
        const editAvatarBtn = document.querySelector(".edit-avatar-btn");

        // é»æ“ŠæŒ‰éˆ•æ™‚ï¼Œæ‰“é–‹æ–‡ä»¶é¸æ“‡è¦–çª—
        editAvatarBtn.addEventListener("click", function () {
            avatarInput.click();
        });

        // ç•¶ç”¨æˆ¶é¸æ“‡åœ–ç‰‡æ™‚
        avatarInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    profileAvatar.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const viewOrderBtns = document.querySelectorAll(".order-btn");
        const agreeButtons = document.querySelectorAll(".btn-agree"); // é¸å–æ‰€æœ‰ã€ŒåŒæ„ã€æŒ‰éˆ•

        // ç›£è½ã€ŒåŒæ„ã€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
        agreeButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.preventDefault(); // é˜²æ­¢é è¨­è¡Œç‚º

                Swal.fire({
                    title: "è¨‚å–®æˆç«‹",
                    icon: "success",
                    confirmButtonText: "ç¢ºèª"
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.setItem("orderConfirmed", "true"); // è¨­å®š localStorage
                        window.location.href = "/my-order"; // è·³è½‰å› my-order.html
                    }
                });
            });
        });

        // åœ¨ my-order.html è¨­å®šã€ŒæŸ¥çœ‹è©³ç´°è¨‚å–®è³‡è¨Šã€æŒ‰éˆ•çš„è·³è½‰ç›®æ¨™
        // //if (viewOrderBtn) { // é€™è¡Œè¨»è§£æ‰ï¼Œå› ç‚º viewOrderBtn æœªå®šç¾©
        //     if (localStorage.getItem("orderConfirmed") === "true") {
        //         viewOrderBtns.forEach(btn => {
        //             // å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹ hrefï¼Œç¢ºä¿ä¿ç•™ order_id
        //             // ä¾‹å¦‚: const orderId = btn.href.split('/').pop(); 
        //             // btn.href = `/orderDetail3/${orderId}`;
        //             // ä½†ç›®å‰æš«æ™‚ä¸ä¿®æ”¹ï¼Œè®“ url_for çš„çµæœç”Ÿæ•ˆ
        //         });
        //     } 
        //     //ä¸å†ç„¡æ¢ä»¶è¨­å®š else { viewOrderBtns.forEach(btn => { btn.href = "/orderDetail"; }); }

        //     // æ¸…é™¤è¨˜éŒ„ï¼Œé¿å…å½±éŸ¿ä¸‹ä¸€æ¬¡é»æ“Š
        //     if (localStorage.getItem("orderConfirmed") === "true") { //åªåœ¨ç¢ºèªå¾Œæ‰æ¸…é™¤
        //        localStorage.removeItem("orderConfirmed");
        //     }
        // //}
    });




</script>
<script src="{{ url_for('static', filename='js/notification.js') }}"></script>
</body>

</html>