<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <title>å»šå¸«ä¼°åƒ¹ - è¨‚å–® #{{ order.order_number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/notification.css') }}">
    <style>
        /* Navbar æ¨£å¼ä¿®æ­£ */
        .navbar .site-name {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .navbar .site-logo {
            width: 35px !important;
            height: 35px !important;
            object-fit: contain !important;
        }
        
        .navbar .site-text {
            display: flex !important;
            flex-direction: column !important;
            gap: 0px !important;
        }
        
        .navbar .site-title {
            font-size: 20px !important;
            font-weight: bold !important;
            color: #B3811C !important;
            line-height: 1.2 !important;
        }
        
        .navbar .site-subtitle {
            font-size: 12px !important;
            font-weight: normal !important;
            color: #B3811C !important;
            opacity: 0.8 !important;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        .user-info .avatar {
            width: 50px !important;
            height: 50px !important;
        }
        
        .user-info .name {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #B3811C !important;
        }
        
        .user-info .email {
            font-size: 16px !important;
            color: #8B6014 !important;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #FFE7B7;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background-color: #F9C765;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar .site-name {
            font-size: 25px;
            font-weight: bold;
            padding-left: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #B3811C;
        }

        .navbar .site-logo {
            width: 35px;
            height: 35px;
            object-fit: contain;
        }

        .navbar .nav-links {
            display: flex;
            gap: 15px;
            margin: 0 auto;
        }

        .navbar a {
            color: #B3811C;
            text-decoration: none;
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
        }

        .navbar a:hover {
            background-color: #f9e4ba;
            border-radius: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
        }

        .user-info .username {
            font-size: 18px;
            color: #B3811C;
            font-weight: bold;
        }

        .user-info .settings-icon {
            width: 20px;
            height: 20px;
            background-image: url('/static/imgs/settings.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        .modal-container {
            position: fixed;
            top: calc(50% + 40px);
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f5f5f5;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 100px);
            overflow-y: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 20px;
            color: #333;
            font-weight: bold;
            margin: 0;
        }

        .close-button {
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-label {
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .info-value {
            color: #333;
            font-size: 16px;
        }

        .menu-list {
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }

        .menu-list::-webkit-scrollbar {
            width: 8px;
        }

        .menu-list::-webkit-scrollbar-track {
            background: #8b8585;
            border-radius: 4px;
        }

        .menu-list::-webkit-scrollbar-thumb {
            background: #F9C765;
            border-radius: 4px;
        }

        .menu-list::-webkit-scrollbar-thumb:hover {
            background: #e5b65c;
        }

        .menu-item {
            margin-bottom: 15px;
        }

        .menu-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .price-input {
            width: 150px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 10px;
            text-align: right;
        }

        .system-price {
            color: #666;
            font-size: 14px;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
        }

        .remark-section {
            flex: 0 0 auto;
            margin-right: 30px;
            width: 250px;
        }

        .remark-input {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            resize: none;
            margin-top: 5px;
        }

        .price-section {
            text-align: right;
            margin-right: 40px;
            margin-top: 20px;
        }

        .price-info {
            text-align: right;
        }

        .price-info-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .rules-button {
            background-color: #F9C765;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: #333;
            font-size: 14px;
            height: 30px;
            white-space: nowrap;
        }

        .rules-button:hover {
            background-color: #e5b65c;
        }

        .rules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .rules-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .rules-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .close-rules {
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .rule-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }

        .rule-section h3 {
            color: #B3811C;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .rule-section ul {
            margin: 0;
            padding-left: 20px;
            color: #555;
        }

        .rule-section li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .price-section-bottom {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .total-price-display {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            padding: 8px 0;
        }

        .confirm-button {
            background-color: #F9C765;
            height: 40px;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            color: #333;
            margin-top: 10px;
        }

        .confirm-button:hover {
            background-color: #e5b65c;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
</head>

<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">å‘³ä½ è€Œç…®</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">é¦–é </a>
            {% if current_user %}
                {% if current_user.role and current_user.role.value == 'chef' %}
                <!-- å»šå¸«å°ˆç”¨å°èˆª -->
                <a href="{{ url_for('chef_dashboard') }}">ç¸½è¦½</a>
                <a href="{{ url_for('chef_pending_orders') }}">å¾…æ¥å–®è¨‚å–®</a>
                
                <!-- å»šå¸«çš„æˆ‘çš„è¨‚å–®ä¸‹æ‹‰é¸å–® -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">æˆ‘çš„è¨‚å–® â–¾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å¾…å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">è­°åƒ¹ä¸­è¨‚å–®</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å–æ¶ˆè¨‚å–®</a>
                    </div>
                </div>
                
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                <a href="#">å®¢æœè¯çµ¡</a>
                {% else %}
                <!-- é¡§å®¢å°ˆç”¨å°èˆª -->
                <a href="/customer/cooking_method">æ–™ç†æ–¹å¼å»ºè­°</a>
                <a href="{{ url_for('order_step0') }}">æ–°å¢è¨‚å–®</a>
                <a href="{{ url_for('customer_order_list') }}">æˆ‘çš„è¨‚å–®</a>
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">é—œæ–¼æˆ‘å€‘</a>
            <a href="{{ url_for('index') }}">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('index') }}">å¸¸è¦‹å•é¡Œ</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if current_user %}
            <img
                src="{{ current_user.avatar_url or '/static/imgs/avatar.png' }}"
                alt="é ­åƒ"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ current_user.name }}</div>
                <div class="email">{{ current_user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">ç™»å…¥/è¨»å†Š</a>
            {% endif %}
        </div>
    </div>

    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">è¨‚å–®ç·¨è™Ÿ #{{ order.order_number }}</h2>
            <span class="close-button" onclick="goBack()">&times;</span>
        </div>

        <div class="info-grid">
            <div class="info-label">é ç´„æ™‚é–“ï¼š<span class="info-value">{{ order.preferred_time.strftime('%Y/%m/%d %H:%M') if order.preferred_time else 'æœªæŒ‡å®š' }}</span></div>
            <div class="info-label">åœ°å€ï¼š<span class="info-value">{{ order.delivery_address or 'æœªæŒ‡å®š' }}</span></div>
            <div class="info-label">å–é¤æ–¹å¼ï¼š<span class="info-value">{{ 'å¤–é€' if order.delivery_method.value == 'delivery' else 'è‡ªå–' }}</span></div>
            <div class="info-label">è¯çµ¡äººè³‡è¨Šï¼š<span class="info-value">{{ order.customer.name }} {{ order.customer.phone or order.customer.email }}</span></div>
        </div>

        <div class="menu-list">
            {% for dish in order.dishes %}
            <div class="menu-item" data-dish-id="{{ dish.id }}">
                <div class="menu-item-header">
                    <div>{{ loop.index }}. {{ dish.dish_name }} {{ dish.quantity }}äººä»½</div>
                    <div>
                        <span>ç¬¬{{ loop.index }}é“åƒ¹æ ¼</span>
                        <input type="number" class="price-input" onchange="calculateTotal()" min="0" step="1">
                    </div>
                </div>
                <div>ï¼ˆé¹¹åº¦:{{ dish.salt_level.value | replace('light', 'æ¸…æ·¡') | replace('normal', 'æ­£å¸¸') | replace('heavy', 'é‡é¹¹') }} 
                     è¾£åº¦:{{ dish.spice_level.value | replace('none', 'ä¸è¾£') | replace('mild', 'å¾®è¾£') | replace('medium', 'ä¸­è¾£') | replace('spicy', 'è¾£') | replace('very_spicy', 'è¶…è¾£') }}ï¼‰</div>
                {% if dish.ingredients %}
                <div>é£Ÿæï¼š{{ dish.ingredients }}</div>
                {% endif %}
                {% if dish.custom_notes %}
                <div>å‚™è¨»ï¼š{{ dish.custom_notes }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="footer">
            <div class="remark-section">
                <div>å‚™è¨»ï¼š</div>
                <textarea class="remark-input" id="pricing-notes" placeholder="ç‰¹æ®Šæ–™ç†åƒ¹æ ¼ç†ç”±æˆ–å…¶ä»–ç‰¹æ®ŠåŸå› "></textarea>
            </div>
            <div class="price-section">
                <div class="price-info">
                    <div class="price-info-row">
                        <button class="rules-button" onclick="showRulesModal()">åƒ¹æ ¼è¨ˆç®—è¦å‰‡</button>
                    </div>
                    <div class="price-section-bottom">
                        <div class="total-price-display">ç¸½é‡‘é¡ï¼š0 å…ƒ</div>
                        <button class="confirm-button" onclick="confirmPrice()">ç¢ºèªé€å‡º</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åƒ¹æ ¼è¦å‰‡æ¨¡æ…‹æ¡† -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <div class="rules-header">
                <h2 class="rules-title">èœå–®åƒ¹æ ¼è¦å‰‡</h2>
                <span class="close-rules" onclick="closeRulesModal()">&times;</span>
            </div>
            <div class="rule-section">
                <h3>1. å»šå¸«è‡ªç”±å®šåƒ¹</h3>
                <ul>
                    <li>å»šå¸«å¯ä»¥æ ¹æ“šé£Ÿææˆæœ¬ã€è£½ä½œæ™‚é–“å’ŒæŠ€è¡“è¦æ±‚è‡ªç”±è¨­å®šåƒ¹æ ¼ã€‚</li>
                    <li>å»ºè­°è€ƒæ…®ç•¶å‰å¸‚å ´èœåƒ¹å’Œè£½ä½œè¤‡é›œåº¦ä¾†å®šåƒ¹ã€‚</li>
                </ul>
            </div>
            <div class="rule-section">
                <h3>2. åˆç†å®šåƒ¹åŸå‰‡</h3>
                <ul>
                    <li>è«‹è€ƒæ…®é£Ÿææˆæœ¬ã€è£½ä½œæ™‚é–“ã€æŠ€è¡“é›£åº¦ç­‰å› ç´ ã€‚</li>
                    <li>å»ºè­°è¨­å®šåˆç†çš„åˆ©æ½¤ç©ºé–“ï¼Œç¢ºä¿æœå‹™å“è³ªã€‚</li>
                </ul>
            </div>
            <div class="rule-section">
                <h3>3. è­°åƒ¹æ©Ÿåˆ¶</h3>
                <ul>
                    <li>æäº¤åƒ¹æ ¼å¾Œï¼Œé¡§å®¢å¯ä»¥æ¥å—æˆ–æå‡ºå†è­°åƒ¹ã€‚</li>
                    <li>æœ€å¤šé€²è¡Œ2è¼ªè­°åƒ¹ï¼Œè‹¥ç„¡æ³•é”æˆå…±è­˜å‰‡è¨‚å–®å–æ¶ˆã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // å¾æ¨¡æ¿å‚³éçš„è®Šé‡
        const orderId = {{ order.id }};
        const chefPendingOrdersUrl = "{{ url_for('chef_pending_orders') }}";
        
        function calculateTotal() {
            const inputs = document.querySelectorAll('.price-input');
            let total = 0;

            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });

            document.querySelector('.total-price-display').textContent = `ç¸½é‡‘é¡ï¼š${total} å…ƒ`;
        }

        function showRulesModal() {
            document.getElementById('rulesModal').style.display = 'block';
        }

        function closeRulesModal() {
            document.getElementById('rulesModal').style.display = 'none';
        }

        function goBack() {
            window.history.back();
        }
        
        // ä¸‹æ‹‰é¸å–®åˆ‡æ›åŠŸèƒ½
        function toggleDropdown() {
            var dropdown = document.getElementById("orderDropdown");
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
            } else {
                dropdown.style.display = "block";
            }
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨æ™‚é—œé–‰æˆ–é—œé–‰ä¸‹æ‹‰é¸å–®
        window.onclick = function (event) {
            const modal = document.getElementById('rulesModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.style.display === "block") {
                        openDropdown.style.display = "none";
                    }
                }
            }
        }

        function confirmPrice() {
            const inputs = document.querySelectorAll('.price-input');
            const pricingNotes = document.getElementById('pricing-notes').value;
            const dishPrices = [];
            let totalAmount = 0;
            let hasEmptyPrice = false;

            inputs.forEach((input, index) => {
                const price = parseFloat(input.value);
                if (!input.value || isNaN(price) || price <= 0) {
                    hasEmptyPrice = true;
                    return;
                }
                dishPrices.push({
                    dish_id: document.querySelectorAll('.menu-item')[index].dataset.dishId,
                    price: price
                });
                totalAmount += price;
            });

            if (hasEmptyPrice) {
                Swal.fire({
                    title: "è«‹å¡«å¯«æ‰€æœ‰èœå“åƒ¹æ ¼",
                    text: "æ‰€æœ‰èœå“éƒ½å¿…é ˆè¨­å®šåƒ¹æ ¼",
                    icon: "warning",
                    confirmButtonText: "ç¢ºèª"
                });
                return;
            }

            // æäº¤åƒ¹æ ¼
            fetch(`/chef/order/${orderId}/submit_pricing`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dish_prices: dishPrices,
                    total_amount: totalAmount,
                    pricing_notes: pricingNotes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "å·²é€²å…¥è­°åƒ¹ç‹€æ…‹",
                        text: "åƒ¹æ ¼å·²æäº¤ï¼Œç­‰å¾…é¡§å®¢å›æ‡‰",
                        icon: "success",
                        confirmButtonText: "ç¢ºèª"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = chefPendingOrdersUrl;
                        }
                    });
                } else {
                    Swal.fire({
                        title: "æäº¤å¤±æ•—",
                        text: data.message,
                        icon: "error",
                        confirmButtonText: "ç¢ºèª"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "ç³»çµ±éŒ¯èª¤",
                    text: "è«‹ç¨å¾Œå†è©¦",
                    icon: "error",
                    confirmButtonText: "ç¢ºèª"
                });
            });
        }
    </script>

    <!-- é€šçŸ¥ä¸­å¿ƒçµ„ä»¶ -->
    {% include 'notification_component.html' %}

    <!-- é€šçŸ¥ä¸­å¿ƒ JavaScript -->
    <script>
        // é€šçŸ¥ç³»çµ±è®Šæ•¸
        let notifications = [];
        let unreadCount = 0;

        // è¼‰å…¥é€šçŸ¥è³‡æ–™
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    console.error('è¼‰å…¥é€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¨™è¨˜å·²è®€éŒ¯èª¤:', error);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é€šçŸ¥
        async function clearAllNotifications() {
            try {
                const response = await fetch('/api/notifications/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    notifications = [];
                    unreadCount = 0;
                    updateNotifications();
                    updateNotificationStatus();
                } else {
                    console.error('æ¸…ç©ºé€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¸…ç©ºé€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // å–å¾—æœªè®€é€šçŸ¥æ•¸é‡
        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                } else {
                    console.error('å–å¾—æœªè®€æ•¸é‡å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('å–å¾—æœªè®€æ•¸é‡éŒ¯èª¤:', error);
            }
        }

        // åˆ‡æ›é€šçŸ¥ä¸­å¿ƒé¡¯ç¤ºç‹€æ…‹
        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) {
                console.error('é€šçŸ¥ä¸­å¿ƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (notificationCenter.style.display === 'none' || !notificationCenter.style.display) {
                await loadNotifications();
                updateNotifications();
                notificationCenter.style.display = 'block';
            } else {
                notificationCenter.style.display = 'none';
            }
        }

        // æ›´æ–°é€šçŸ¥é€£çµçš„ç‹€æ…‹ï¼ˆæœªè®€æç¤ºï¼‰
        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.style.position = 'relative';
                notificationLink.innerHTML = `é€šçŸ¥ä¸­å¿ƒ <span style="position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;">${unreadCount}</span>`;
            } else {
                notificationLink.innerHTML = 'é€šçŸ¥ä¸­å¿ƒ';
            }
        }

        // è™•ç†é€šçŸ¥é»æ“Šè·³è½‰
        function handleNotificationClick(notification) {
            let targetUrl = '';
            
            switch(notification.type) {
                case 'new_order':
                    // æ–°è¨‚å–® -> å¾…æ¥å–®é é¢
                    targetUrl = '/chef/pending-orders';
                    break;
                case 'order_completed':
                    // è¨‚å–®å®Œæˆ -> å·²å®Œæˆè¨‚å–®é é¢
                    targetUrl = '/chef/completed-orders';
                    break;
                case 'new_review':
                    // æ–°è©•åƒ¹ -> å»šå¸«å„€è¡¨æ¿ï¼ˆæŸ¥çœ‹è©•åƒ¹ï¼‰
                    targetUrl = '/chef/';
                    break;
                case 'negotiation_response':
                    // è­°åƒ¹å›æ‡‰ -> è­°åƒ¹ä¸­è¨‚å–®é é¢
                    targetUrl = '/chef/negotiating-orders';
                    break;
                case 'order_accepted':
                case 'order_rejected':
                case 'order_ready':
                    // è¨‚å–®ç‹€æ…‹æ›´æ–° -> å°æ‡‰çš„è¨‚å–®è©³æƒ…
                    if (notification.order_id) {
                        targetUrl = `/chef/order/${notification.order_id}`;
                    }
                    break;
                default:
                    // é è¨­è·³è½‰åˆ°å„€è¡¨æ¿
                    targetUrl = '/chef/';
                    break;
            }
            
            if (targetUrl) {
                // é—œé–‰é€šçŸ¥ä¸­å¿ƒ
                const notificationCenter = document.getElementById('notificationCenter');
                if (notificationCenter) {
                    notificationCenter.style.display = 'none';
                }
                // è·³è½‰é é¢
                window.location.href = targetUrl;
            }
        }

        // æ›´æ–°é€šçŸ¥åˆ—è¡¨é¡¯ç¤º
        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;

            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš«ç„¡é€šçŸ¥</div>';
                notificationList.appendChild(li);
                return;
            }

            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                if (!notification.is_read) {
                    li.classList.add('unread');
                }

                // é€šçŸ¥é¡å‹åœ–æ¨™
                const typeIcon = {
                    'new_order': 'ğŸ“‹',
                    'order_completed': 'âœ…',
                    'new_review': 'â­',
                    'negotiation_response': 'ğŸ’¬',
                    'order_accepted': 'âœ…',
                    'order_rejected': 'âŒ',
                    'order_ready': 'ğŸ½ï¸',
                    'review_reply': 'ğŸ’¬'
                };
                const icon = typeIcon[notification.type] || 'ğŸ“¢';

                // åˆ¤æ–·æ˜¯å¦ç‚ºè¨‚å–®é¡é€šçŸ¥ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        li.classList.remove('unread');
                        li.querySelector('.notification-content > div').style.fontWeight = 'normal';
                        updateNotificationStatus();
                    }
                    
                    // æ ¹æ“šé€šçŸ¥é¡å‹è·³è½‰åˆ°å°æ‡‰é é¢
                    handleNotificationClick(notification);
                });

                notificationList.appendChild(li);
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationCenter = document.getElementById('notificationCenter');
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
        });

        // å®šæœŸæ›´æ–°æœªè®€é€šçŸ¥æ•¸é‡
        setInterval(getUnreadCount, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    </script>
</body>

</html> 