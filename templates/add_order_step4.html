<!DOCTYPE html>
<html lang="zh">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cactus+Classical+Serif&family=Noto+Sans+HK:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap"
        rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/css/reserve4.css" rel="stylesheet" />
    <link href="/static/css/notification.css" rel="stylesheet" />
    <title>代做菜媒合平台</title>
</head>

<body>
    <div class="navbar">
        <div class="site-name">味你而煮</div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            {% if user %}
            <a href="CookingMethod.html">料理方式建議</a>
            <a href="{{ url_for('order_step0') }}">新增訂單</a>
            <a href="{{ url_for('customer_order_list') }}">我的訂單</a>
            <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
            {% else %}
            <a href="{{ url_for('index') }}">關於我們</a>
            <a href="{{ url_for('index') }}">料理方式建議</a>
            <a href="{{ url_for('index') }}">常見問題</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>
    <!-- 通知中心視窗 -->
    <div class="notification-center" id="notificationCenter">
        <div class="notification-header">
            <span>通知中心</span>
            <button class="clear-all" onclick="clearAllNotifications()">清空通知</button>
        </div>
        <ul class="notification-list" id="notificationList">
            <!-- 通知項目會動態添加在這裡 -->
        </ul>
    </div>

    <div class="content">
        <div class="section">
            <h3>Step4 - 訂單確認</h3>

            <!-- 顯示預約資訊與靜態聯絡資訊 -->
            <div class="order-summary">
                <label class="order-time"><strong>預約日期/時間:</strong> {{ step1.order_date }} / {{ step1.order_time }}</label>
                <br><br>
                <label class="order-time"><strong>取餐方式:</strong> {{ step1.pickup_method }}</label>
                <br><br>
                {% if step1.pickup_method == '外送' and step1.address %}
                <label class="order-time"><strong>外送地址:</strong> {{ step1.address }}</label>
                <br><br>
                {% endif %}
                <label class="order-time"><strong>聯絡人資訊:</strong> {{ user.phone or '' }}</label>
                <br><br>
            </div>

            <!-- 菜單列表 -->
            <label class="order-time"><strong>菜單列表:</strong></label>
            <br><br>
            <div class="meal-container">
                <ul class="meal-list">
                    {% for dish in dishes %}
                    <li>
                        {{ dish.dish_name }} - <span class="price" data-price="{{ dish.unit_price }}" data-quantity="{{ dish.quantity }}">{{ dish.unit_price }}</span> 元 × {{ dish.quantity }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <br>

            <!-- 動態總價 -->
            {% set total_price = 0 %}
            {% for dish in dishes %}
                {% set total_price = total_price + (dish.unit_price * dish.quantity) %}
            {% endfor %}
            <label class="order-time"><strong>預估價格:</strong> <span id="totalPrice">{{ "%.0f"|format(total_price) }}</span> 元</label>
            <br><br>

            <!-- 按鈕 -->
            <form id="step4-form" method="post" action="{{ url_for('order_step4') }}">
                <input type="hidden" name="contact_phone" value="{{ user.phone or '' }}" />
                <button class="next-button" type="button" onclick="location.href='/customer/orders/new/step3';">上一步</button>
                
                <button class="save-button" type="submit">確認送出</button>
            </form>
        </div>
    </div>

    <div class="progress-bar">
        <div class="step">選擇廚師</div>
        <div class="line"></div>
        <div class="step">第1步</div>
        <div class="line"></div>
        <div class="step">第2步</div>
        <div class="line"></div>
        <div class="step">第3步</div>
        <div class="line"></div>
        <div class="step active">第4步</div>
    </div>


    <!-- 設定小視窗 -->
    <div class="settings-modal" id="settings-modal">
        <div class="modal-content">
            <h2>設定</h2>
            <p>帳號</p>
            <p>其他</p>
            <button class="close-btn" onclick="toggleSettingsModal()">儲存</button>
        </div>
    </div>

    <!-- 引入 SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function toggleSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleNotification() {
            const modal = document.getElementById('notificationCenter');
            if (modal) {
                modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            }
        }

        // 計算總價格
        function calculateTotalPrice() {
            const priceElements = document.querySelectorAll(".price");
            let total = 0;

            priceElements.forEach(priceElement => {
                const price = parseFloat(priceElement.dataset.price) || 0;
                const quantity = parseInt(priceElement.dataset.quantity) || 1;
                total += price * quantity;
            });

            document.getElementById("totalPrice").textContent = Math.round(total);
        }

        // 頁面載入時計算總價
        document.addEventListener("DOMContentLoaded", function () {
            calculateTotalPrice();
        });

        document.getElementById('step4-form').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '確認送出訂單？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then((res) => {
                if (res.isConfirmed) {
                    e.target.submit();
                }
            });
        });
    </script>
    <script src="/static/js/notification.js"></script>
</body>

</html>