<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <title>èªéŸ³AIåŠ©æ‰‹ - æ–°å¢è¨‚å–®</title>
    <link href="/static/css/SearchChef.css" rel="stylesheet" />
    <link href="/static/css/notification.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
    
    <style>
        /* Navbar æ¨£å¼ä¿®æ­£ */
        .navbar .site-name {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .navbar .site-logo {
            width: 35px !important;
            height: 35px !important;
            object-fit: contain !important;
        }
        
        .navbar .site-text {
            display: flex !important;
            flex-direction: column !important;
            gap: 0px !important;
        }
        
        .navbar .site-title {
            font-size: 20px !important;
            font-weight: bold !important;
            color: #B3811C !important;
            line-height: 1.2 !important;
        }
        
        .navbar .site-subtitle {
            font-size: 12px !important;
            font-weight: normal !important;
            color: #B3811C !important;
            opacity: 0.8 !important;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        .user-info .name {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #B3811C !important;
        }
        
        .user-info .email {
            font-size: 16px !important;
            color: #8B6014 !important;
        }

        /* Navbar z-index è¨­å®š */
        .navbar {
            z-index: 1000 !important;
        }

        /* ç¾ä»£åŒ–è¨­å®šæ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #F9C765 0%, #e8b84f 100%);
            padding: 20px 25px;
            color: #B3811C;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close {
            color: #B3811C;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background-color: rgba(179, 129, 28, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* å¸³è™Ÿå€å¡Š */
        .account-section {
            margin-bottom: 15px;
        }

        .account-info-modern {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .account-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 3px solid #F9C765;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .account-details {
            flex: 1;
        }

        .account-name {
            font-weight: bold;
            color: #B3811C;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .account-email {
            color: #6c757d;
            font-size: 14px;
        }

        /* è¨­å®šé …ç›® */
        .setting-item {
            display: flex;
            align-items: center;
            padding: 15px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            background: #fff;
            border: 1px solid #e9ecef;
        }

        .setting-item:hover {
            background-color: #f8f9fa;
        }

        .setting-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 25px;
            text-align: center;
        }

        .setting-text {
            flex: 1;
        }

        .setting-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 12px;
            color: #6c757d;
        }

        .setting-arrow {
            font-size: 16px;
            color: #adb5bd;
        }

        /* åˆ†éš”ç·š */
        hr {
            border: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, #e9ecef, transparent);
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        /* å€‹äººè³‡æ–™ç·¨è¼¯æ¨¡æ…‹æ¡†æ¨£å¼ */
        #profileModal .modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #profileModal .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 120px);
            -webkit-overflow-scrolling: touch;
        }

        #profileModal .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        #profileModal .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #profileModal .modal-body::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 4px;
        }

        #profileModal .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        .avatar-edit-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .profile-edit-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 4px solid #f6c25f;
            object-fit: cover;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .avatar-upload-btn {
            background: linear-gradient(135deg, #f6c25f, #e0a93d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: box-shadow 0.3s ease, background 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .avatar-upload-btn:hover {
            box-shadow: 0 5px 15px rgba(246, 194, 95, 0.4);
            background: linear-gradient(135deg, #e0a93d, #d89e3a);
        }

        .form-group-modern {
            margin-bottom: 20px;
        }

        .form-group-modern label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group-modern input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group-modern input:focus {
            outline: none;
            border-color: #f6c25f;
            box-shadow: 0 0 0 3px rgba(246, 194, 95, 0.1);
        }

        .form-group-modern input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .password-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .password-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
        }

        /* OAuth2 å¯†ç¢¼é€šçŸ¥æ¨£å¼ */
        .oauth-password-notice {
            display: flex;
            align-items: flex-start;
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            border: 1px solid #90caf9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .oauth-notice-icon {
            font-size: 24px;
            margin-right: 15px;
            margin-top: 5px;
        }

        .oauth-notice-text {
            flex: 1;
        }

        .oauth-notice-text p {
            margin: 0 0 8px 0;
            color: #1976d2;
            font-size: 14px;
            line-height: 1.5;
        }

        .oauth-notice-text p:first-child {
            font-weight: bold;
            font-size: 16px;
            color: #0d47a1;
        }

        .oauth-notice-text p:last-child {
            margin-bottom: 0;
        }

        /* ç¦ç”¨ç‹€æ…‹æ¨£å¼ */
        .disabled-label {
            color: #999 !important;
            opacity: 0.7;
        }

        .disabled-input {
            background-color: #f5f5f5 !important;
            color: #999 !important;
            border-color: #ddd !important;
            cursor: not-allowed !important;
        }

        .profile-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn-save {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* èªéŸ³åŠ©æ‰‹é é¢æ¨£å¼ */
        .voice-assistant-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            background: #f8f9fa;
            min-height: calc(100vh - 100px);
        }

        .assistant-header {
            background: linear-gradient(135deg, #F9C765 0%, #e8b84f 100%);
            color: #B3811C;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
        }

        .assistant-header h1 {
            margin: 0 0 6px 0;
            font-size: 18px;
        }

        .assistant-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-container {
            display: flex;
            gap: 12px;
            height: calc(100vh - 160px);
            min-height: 400px;
        }

        .chat-window {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #B3811C;
            color: white;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header .ai-icon {
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0; /* ç¢ºä¿flexå­å…ƒç´ å¯ä»¥ç¸®å° */
        }

        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 14px;
        }

        .message.user {
            background: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            align-self: center;
            text-align: center;
            font-style: italic;
            border-radius: 8px;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0; /* é˜²æ­¢è¼¸å…¥æ¡†è¢«å£“ç¸® */
        }

        .chat-input input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #F9C765;
        }

        .voice-btn {
            background: linear-gradient(135deg, #F9C765 0%, #e8b84f 100%);
            color: #B3811C;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(249, 199, 101, 0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .send-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .send-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .order-summary {
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* é˜²æ­¢æ‘˜è¦é¢æ¿è¢«å£“ç¸® */
            max-height: 100%; /* ç¢ºä¿ä¸è¶…å‡ºå®¹å™¨é«˜åº¦ */
        }

        .summary-header {
            background: #B3811C;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            text-align: center;
            font-size: 14px;
        }

        .summary-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .summary-section h4 {
            color: #B3811C;
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-item:last-child {
            margin-bottom: 0;
        }

        .summary-label {
            color: #666;
        }

        .summary-value {
            color: #333;
            font-weight: 500;
        }

        .action-buttons {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #B3811C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.ready {
            background: #28a745;
        }

        .status-indicator.processing {
            background: #ffc107;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .voice-assistant-container {
                max-width: 95%;
                padding: 8px;
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
                min-height: 400px;
                gap: 10px;
            }
            
            .order-summary {
                width: 100%;
                order: -1;
                margin-bottom: 15px;
            }
            
            .chat-window {
                height: 350px;
                min-height: 350px;
            }
            
            .assistant-header h1 {
                font-size: 16px;
            }
            
            .assistant-header p {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">å‘³ä½ è€Œç…®</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">é¦–é </a>
            {% if user %}
                {% if user.role and user.role.value == 'chef' %}
                <!-- å»šå¸«å°ˆç”¨å°èˆª -->
                <a href="{{ url_for('chef_dashboard') }}">ç¸½è¦½</a>
                <a href="{{ url_for('chef_pending_orders') }}">å¾…æ¥å–®è¨‚å–®</a>
                
                <!-- å»šå¸«çš„æˆ‘çš„è¨‚å–®ä¸‹æ‹‰é¸å–® -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">æˆ‘çš„è¨‚å–® â–¾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å¾…å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">è­°åƒ¹ä¸­è¨‚å–®</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å–æ¶ˆè¨‚å–®</a>
                    </div>
                </div>
                
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                <a href="#">å®¢æœè¯çµ¡</a>
                {% else %}
                <!-- é¡§å®¢å°ˆç”¨å°èˆª -->
                <a href="/customer/cooking_method">æ–™ç†æ–¹å¼å»ºè­°</a>
                <a href="{{ url_for('order_step0') }}">æ–°å¢è¨‚å–®</a>
                <a href="{{ url_for('customer_order_list') }}">æˆ‘çš„è¨‚å–®</a>
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">é—œæ–¼æˆ‘å€‘</a>
            <a href="{{ url_for('index') }}">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('index') }}">å¸¸è¦‹å•é¡Œ</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="é ­åƒ"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">ç™»å…¥/è¨»å†Š</a>
            {% endif %}
        </div>
    </div>

    <!-- é€šçŸ¥ä¸­å¿ƒ -->
    {% include 'notification_component.html' %}

    <!-- ç¾ä»£åŒ–è¨­å®šå½ˆçª— -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å¸³æˆ¶è¨­å®š</h3>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- å¸³è™Ÿè³‡è¨Šå€å¡Š -->
                <div class="account-section">
                    <div class="account-info-modern">
                        <img src="{{ avatar_url }}" alt="Avatar" class="account-avatar">
                        <div class="account-details">
                            <div class="account-name">{{ user.name }}</div>
                            <div class="account-email">{{ user.email }}</div>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showProfileEditor()">
                        <div class="setting-icon">ğŸ‘¤</div>
                        <div class="setting-text">
                            <div class="setting-title">ç·¨è¼¯å€‹äººè³‡æ–™</div>
                            <div class="setting-desc">ä¿®æ”¹å§“åã€é ­åƒæˆ–å¯†ç¢¼</div>
                        </div>
                        <div class="setting-arrow">â†’</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="setting-item" onclick="window.location.href='/customer/special-needs-verification'">
                    <div class="setting-icon">ğŸ¥</div>
                    <div class="setting-text">
                        <div class="setting-title">èº«å¿ƒéšœç¤™è€…/é«˜é½¡è€…é©—è­‰</div>
                        <div class="setting-desc">ç”³è«‹ç‰¹æ®Šéœ€æ±‚ç”¨æˆ¶é©—è­‰</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>
                
                <div class="setting-item" onclick="window.location.href='/customer/special-needs-status'">
                    <div class="setting-icon">ğŸ“‹</div>
                    <div class="setting-text">
                        <div class="setting-title">æŸ¥çœ‹é©—è­‰ç‹€æ…‹</div>
                        <div class="setting-desc">æŸ¥çœ‹ç”³è«‹å¯©æ ¸é€²åº¦</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>
                
                <hr>
                
                <div class="setting-item" onclick="window.location.href='/auth/logout'">
                    <div class="setting-icon">ğŸšª</div>
                    <div class="setting-text">
                        <div class="setting-title">ç™»å‡º</div>
                        <div class="setting-desc">ç™»å‡ºç›®å‰å¸³æˆ¶</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å€‹äººè³‡æ–™ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯å€‹äººè³‡æ–™</h3>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="profile-form" enctype="multipart/form-data">
                    <!-- é ­åƒç·¨è¼¯å€å¡Š -->
                    <div class="avatar-edit-container">
                        <img src="{{ user.avatar_url or '/static/imgs/avatar.png' }}" alt="Profile Avatar" class="profile-edit-avatar" id="profileEditAvatar">
                        <label for="avatarInput" class="avatar-upload-btn">
                            ğŸ“· æ›´æ›é ­åƒ
                            <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;">
                        </label>
                    </div>
                    
                    <!-- åŸºæœ¬è³‡è¨Šç·¨è¼¯ -->
                    <div class="form-group-modern">
                        <label for="name">å§“å</label>
                        <input type="text" id="name" name="name" value="{{ user.name }}" required>
                    </div>
                    
                    <div class="form-group-modern">
                        <label for="email">é›»å­éƒµä»¶</label>
                        <input type="email" id="email" value="{{ user.email }}" readonly style="background: #f8f9fa; cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group-modern">
                        <label for="phone">é›»è©±è™Ÿç¢¼</label>
                        <input type="tel" id="phone" name="phone" value="{{ user.phone or '' }}" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
                    </div>
                    
                    <!-- å¯†ç¢¼ä¿®æ”¹å€å¡Š -->
                    <div class="password-section">
                        <h4>å¯†ç¢¼è¨­å®š</h4>
                        {% if user.oauth_provider %}
                        <!-- OAuth2 ç”¨æˆ¶ç„¡æ³•ä¿®æ”¹å¯†ç¢¼ -->
                        <div class="oauth-password-notice">
                            <div class="oauth-notice-icon">ğŸ”’</div>
                            <div class="oauth-notice-text">
                                <p><strong>Google å¸³æˆ¶ç™»å…¥</strong></p>
                                <p>æ‚¨ä½¿ç”¨çš„æ˜¯ Google OAuth2 ç™»å…¥ï¼Œå¯†ç¢¼ç”± Google ç®¡ç†ï¼Œç„¡æ³•åœ¨æ­¤ä¿®æ”¹ã€‚</p>
                                <p>å¦‚éœ€ä¿®æ”¹å¯†ç¢¼ï¼Œè«‹å‰å¾€æ‚¨çš„ Google å¸³æˆ¶è¨­å®šã€‚</p>
                            </div>
                        </div>
                        <div class="form-group-modern">
                            <label for="current_password" class="disabled-label">ç›®å‰å¯†ç¢¼</label>
                            <input type="password" id="current_password" name="current_password" placeholder="OAuth2 ç™»å…¥ç”¨æˆ¶ç„¡æ³•ä¿®æ”¹å¯†ç¢¼" disabled class="disabled-input">
                        </div>
                        
                        <div class="form-group-modern">
                            <label for="new_password" class="disabled-label">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new_password" name="new_password" placeholder="OAuth2 ç™»å…¥ç”¨æˆ¶ç„¡æ³•ä¿®æ”¹å¯†ç¢¼" disabled class="disabled-input">
                        </div>
                        {% else %}
                        <!-- ä¸€èˆ¬ç”¨æˆ¶å¯ä»¥ä¿®æ”¹å¯†ç¢¼ -->
                        <div class="form-group-modern">
                            <label for="current_password">ç›®å‰å¯†ç¢¼</label>
                            <input type="password" id="current_password" name="current_password" placeholder="ä¿®æ”¹å¯†ç¢¼æ™‚è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼">
                        </div>
                        
                        <div class="form-group-modern">
                            <label for="new_password">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new_password" name="new_password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆä¸ä¿®æ”¹è«‹ç•™ç©ºï¼‰">
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="profile-actions">
                        <button type="submit" class="btn-save">å„²å­˜è®Šæ›´</button>
                        <button type="button" class="btn-cancel" onclick="closeProfileModal()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="voice-assistant-container">
        <div class="assistant-header">
            <h1>èªéŸ³AIåŠ©æ‰‹</h1>
            <p>ä½¿ç”¨èªéŸ³è¼¸å…¥ï¼ŒAIå°‡å¼•å°æ‚¨å®Œæˆè¨‚å–®å‰µå»º</p>
        </div>

        <div class="chat-container">
            <!-- èŠå¤©çª—å£ -->
            <div class="chat-window">
                <div class="chat-header">
                    <!-- <span class="ai-icon">AI</span> -->
                    <span>AIè¨‚å–®åŠ©æ‰‹</span>
                    <!-- <span class="status-indicator ready" id="statusIndicator"></span>
                    <span id="statusText">æº–å‚™å°±ç·’</span> -->
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è¨‚å–®åŠ©æ‰‹ã€‚è«‹å‘Šè¨´æˆ‘æ‚¨æƒ³è¦è¨‚è£½ä»€éº¼æ¨£çš„æ–™ç†ï¼Œæˆ‘æœƒå¼•å°æ‚¨å®Œæˆæ•´å€‹è¨‚å–®æµç¨‹ã€‚
                        <br><br>
                        æ‚¨å¯ä»¥ï¼š
                        <br>â€¢ ç›´æ¥èªªå‡ºæ‚¨æƒ³è¦çš„èœè‰²
                        <br>â€¢ å‘Šè¨´æˆ‘ç”¨é¤æ™‚é–“å’Œåœ°é»
                        <br>â€¢ èªªæ˜æ‚¨çš„å£å‘³åå¥½
                        <br><br>
                        è«‹é–‹å§‹èªªè©±ï¼Œæˆ–é»æ“Šéº¥å…‹é¢¨æŒ‰éˆ•é–‹å§‹èªéŸ³è¼¸å…¥ï¼
                    </div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯æˆ–ä½¿ç”¨èªéŸ³..." onkeypress="handleKeyPress(event)">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="èªéŸ³è¼¸å…¥">
                        ğŸ¤
                    </button>
                    <button class="send-btn" onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>

            <!-- è¨‚å–®æ‘˜è¦ -->
            <div class="order-summary">
                <div class="summary-header">
                    <h3>è¨‚å–®æ‘˜è¦</h3>
                </div>
                
                <div class="summary-section">
                    <h4>å»šå¸«è³‡è¨Š</h4>
                    <div class="summary-item">
                        <span class="summary-label">å»šå¸«ï¼š</span>
                        <span class="summary-value" id="chefName">{{ chef.name }}</span>
                    </div>
                </div>
                
                <div class="summary-section">
                    <h4>åŸºæœ¬è³‡è¨Š</h4>
                    <div class="summary-item">
                        <span class="summary-label">æ—¥æœŸï¼š</span>
                        <span class="summary-value" id="orderDate">æœªè¨­å®š</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">æ™‚é–“ï¼š</span>
                        <span class="summary-value" id="orderTime">æœªè¨­å®š</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">å–é¤æ–¹å¼ï¼š</span>
                        <span class="summary-value" id="deliveryMethod">æœªè¨­å®š</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">åœ°å€ï¼š</span>
                        <span class="summary-value" id="deliveryAddress">æœªè¨­å®š</span>
                    </div>
                </div>
                
                <div class="summary-section">
                    <h4>èœå–®</h4>
                    <div id="dishesList">
                        <div class="summary-item">
                            <span class="summary-label">å°šç„¡èœè‰²</span>
                        </div>
                    </div>
                </div>
                
                <div class="summary-section">
                    <h4>å‚™è¨»</h4>
                    <div class="summary-item">
                        <span class="summary-value" id="customerNotes">ç„¡</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-primary" id="submitOrderBtn" onclick="submitOrder()" disabled>
                        ç¢ºèªä¸¦é€å‡ºè¨‚å–®
                    </button>
                    <button class="btn-secondary" onclick="goBack()">
                        è¿”å›é¸æ“‡å»šå¸«
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let orderData = {
            chef_id: {{ chef.id }},
            chef_name: "{{ chef.name }}",
            order_date: null,
            order_time: null,
            delivery_method: null,
            delivery_address: null,
            dishes: [],
            customer_notes: ""
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateOrderSummary();
        });

        // ç™¼é€è¨Šæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯åˆ°èŠå¤©
            addMessage('user', message);
            input.value = '';
            
            // é¡¯ç¤ºAIè™•ç†ä¸­
            const processingId = addMessage('assistant', '<div class="loading"></div> æ­£åœ¨è™•ç†æ‚¨çš„è¨Šæ¯...');
            updateStatus('processing', 'è™•ç†ä¸­');
            
            try {
                // ç™¼é€åˆ°å¾Œç«¯è™•ç†
                const response = await fetch('/customer/orders/new/voice_assistant/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        order_data: orderData
                    })
                });
                
                const result = await response.json();
                
                // ç§»é™¤è™•ç†ä¸­è¨Šæ¯
                removeMessage(processingId);
                
                if (result.success) {
                    // æ›´æ–°è¨‚å–®æ•¸æ“š
                    if (result.order_data) {
                        orderData = { ...orderData, ...result.order_data };
                        updateOrderSummary();
                    }
                    
                    // æ·»åŠ AIå›æ‡‰
                    addMessage('assistant', result.response);
                    
                    // æª¢æŸ¥æ˜¯å¦å®Œæˆ
                    if (result.is_complete) {
                        document.getElementById('submitOrderBtn').disabled = false;
                        addMessage('system', 'âœ… è¨‚å–®è³‡è¨Šå·²æ”¶é›†å®Œæˆï¼æ‚¨å¯ä»¥ç¢ºèªä¸¦é€å‡ºè¨‚å–®ã€‚');
                    }
                    
                    updateStatus('ready', 'æº–å‚™å°±ç·’');
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œè™•ç†æ‚¨çš„è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + result.message);
                    updateStatus('error', 'éŒ¯èª¤');
                }
            } catch (error) {
                removeMessage(processingId);
                addMessage('assistant', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                updateStatus('error', 'éŒ¯èª¤');
                console.error('Error:', error);
            }
        }

        // èªéŸ³éŒ„è£½åŠŸèƒ½
        async function toggleVoiceRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = 'â¹ï¸';
                voiceBtn.title = 'åœæ­¢éŒ„éŸ³';
                
                updateStatus('processing', 'éŒ„éŸ³ä¸­');
                addMessage('system', 'ğŸ¤ æ­£åœ¨éŒ„éŸ³...è«‹èªªè©±');
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                addMessage('assistant', 'ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®šã€‚');
                updateStatus('error', 'éº¥å…‹é¢¨éŒ¯èª¤');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = 'ğŸ¤';
                voiceBtn.title = 'èªéŸ³è¼¸å…¥';
                
                updateStatus('processing', 'è½‰æ›èªéŸ³ä¸­');
                addMessage('system', 'ğŸ”„ æ­£åœ¨è½‰æ›èªéŸ³...');
            }
        }

        async function processAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                
                const response = await fetch('/customer/orders/new/voice_assistant/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const transcribedText = result.text;
                    addMessage('user', `ğŸ¤ ${transcribedText}`);
                    
                    // è‡ªå‹•ç™¼é€è½‰éŒ„çš„æ–‡å­—
                    document.getElementById('messageInput').value = transcribedText;
                    await sendMessage();
                } else {
                    addMessage('assistant', 'èªéŸ³è½‰æ›å¤±æ•—ï¼š' + result.message);
                    updateStatus('error', 'è½‰æ›å¤±æ•—');
                }
            } catch (error) {
                addMessage('assistant', 'èªéŸ³è™•ç†éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                updateStatus('error', 'è™•ç†éŒ¯èª¤');
                console.error('Error processing audio:', error);
            }
        }

        // èŠå¤©ç•Œé¢åŠŸèƒ½
        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            messageDiv.id = 'msg_' + Date.now();
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv.id;
        }

        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // è¨‚å–®æ‘˜è¦æ›´æ–°
        function updateOrderSummary() {
            document.getElementById('orderDate').textContent = orderData.order_date || 'æœªè¨­å®š';
            document.getElementById('orderTime').textContent = orderData.order_time || 'æœªè¨­å®š';
            document.getElementById('deliveryMethod').textContent = orderData.delivery_method || 'æœªè¨­å®š';
            document.getElementById('deliveryAddress').textContent = orderData.delivery_address || 'æœªè¨­å®š';
            document.getElementById('customerNotes').textContent = orderData.customer_notes || 'ç„¡';
            
            // æ›´æ–°èœå–®åˆ—è¡¨
            const dishesList = document.getElementById('dishesList');
            if (orderData.dishes && orderData.dishes.length > 0) {
                dishesList.innerHTML = '';
                orderData.dishes.forEach((dish, index) => {
                    const dishDiv = document.createElement('div');
                    dishDiv.className = 'summary-item';
                    dishDiv.innerHTML = `
                        <span class="summary-label">${dish.dish_name} Ã— ${dish.quantity}</span>
                        <span class="summary-value">${dish.salt_level} / ${dish.spice_level}</span>
                    `;
                    dishesList.appendChild(dishDiv);
                });
            } else {
                dishesList.innerHTML = '<div class="summary-item"><span class="summary-label">å°šç„¡èœè‰²</span></div>';
            }
        }

        // æäº¤è¨‚å–®
        async function submitOrder() {
            if (!orderData.order_date || !orderData.order_time || !orderData.delivery_method || orderData.dishes.length === 0) {
                addMessage('assistant', 'è¨‚å–®è³‡è¨Šä¸å®Œæ•´ï¼Œè«‹æä¾›æ‰€æœ‰å¿…è¦è³‡è¨Šã€‚');
                return;
            }
            
            const confirmed = await Swal.fire({
                title: 'ç¢ºèªé€å‡ºè¨‚å–®ï¼Ÿ',
                text: 'è«‹ç¢ºèªæ‰€æœ‰è³‡è¨Šæ­£ç¢ºå¾Œé€å‡ºè¨‚å–®',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                cancelButtonText: 'å–æ¶ˆ'
            });
            
            if (confirmed.isConfirmed) {
                try {
                    updateStatus('processing', 'é€å‡ºä¸­');
                    addMessage('system', 'ğŸ“¤ æ­£åœ¨é€å‡ºè¨‚å–®...');
                    
                    const response = await fetch('/customer/orders/new/voice_assistant/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addMessage('system', 'âœ… è¨‚å–®å·²æˆåŠŸé€å‡ºï¼');
                        updateStatus('ready', 'è¨‚å–®å·²é€å‡º');
                        
                        await Swal.fire({
                            title: 'è¨‚å–®é€å‡ºæˆåŠŸï¼',
                            text: `è¨‚å–®ç·¨è™Ÿï¼š${result.order_number}`,
                            icon: 'success',
                            confirmButtonText: 'æŸ¥çœ‹è¨‚å–®'
                        });
                        
                        window.location.href = `/customer/order/${result.order_id}`;
                    } else {
                        addMessage('assistant', 'è¨‚å–®é€å‡ºå¤±æ•—ï¼š' + result.message);
                        updateStatus('error', 'é€å‡ºå¤±æ•—');
                    }
                } catch (error) {
                    addMessage('assistant', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    updateStatus('error', 'ç¶²è·¯éŒ¯èª¤');
                    console.error('Error submitting order:', error);
                }
            }
        }

        // è¿”å›
        function goBack() {
            window.location.href = "{{ url_for('order_step0') }}";
        }

        // ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function toggleDropdown() {
            const dropdown = document.getElementById('orderDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        // è¨­å®šæ¨¡æ…‹æ¡†åŠŸèƒ½
        function toggleSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showProfileEditor() {
            closeSettingsModal();
            // æ‰“é–‹å€‹äººè³‡æ–™ç·¨è¼¯æ¨¡æ…‹æ¡†
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal');
            const profileModal = document.getElementById('profileModal');
            if (event.target === settingsModal) {
                closeSettingsModal();
            } else if (event.target === profileModal) {
                closeProfileModal();
            }
        }

        // å€‹äººè³‡æ–™ç·¨è¼¯åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // é ­åƒé è¦½åŠŸèƒ½
            const avatarInput = document.getElementById('avatarInput');
            const profileEditAvatar = document.getElementById('profileEditAvatar');
            
            if (avatarInput && profileEditAvatar) {
                avatarInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            profileEditAvatar.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // å€‹äººè³‡æ–™è¡¨å–®æäº¤
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(profileForm);
                    const submitBtn = profileForm.querySelector('.btn-save');
                    const originalText = submitBtn.textContent;
                    
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    submitBtn.textContent = 'å„²å­˜ä¸­...';
                    submitBtn.disabled = true;
                    
                    try {
                        const response = await fetch('/customer/profile/update', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            // æ›´æ–°æˆåŠŸ
                            if (result.avatar_url) {
                                // æ›´æ–°navbarä¸­çš„é ­åƒ
                                const navbarAvatar = document.querySelector('.user-info .avatar');
                                if (navbarAvatar) {
                                    navbarAvatar.src = result.avatar_url;
                                }
                                // æ›´æ–°è¨­å®šæ¨¡æ…‹æ¡†ä¸­çš„é ­åƒ
                                const settingsAvatar = document.querySelector('.account-avatar');
                                if (settingsAvatar) {
                                    settingsAvatar.src = result.avatar_url;
                                }
                            }
                            
                            if (result.name) {
                                // æ›´æ–°navbarä¸­çš„å§“å
                                const navbarName = document.querySelector('.user-info .name');
                                if (navbarName) {
                                    navbarName.textContent = result.name;
                                }
                                // æ›´æ–°è¨­å®šæ¨¡æ…‹æ¡†ä¸­çš„å§“å
                                const settingsName = document.querySelector('.account-name');
                                if (settingsName) {
                                    settingsName.textContent = result.name;
                                }
                            }
                            
                            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                            Swal.fire({
                                icon: 'success',
                                title: 'æ›´æ–°æˆåŠŸï¼',
                                text: 'å€‹äººè³‡æ–™å·²æˆåŠŸæ›´æ–°',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            
                            // é—œé–‰æ¨¡æ…‹æ¡†
                            closeProfileModal();
                            
                        } else {
                            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                            Swal.fire({
                                icon: 'error',
                                title: 'æ›´æ–°å¤±æ•—',
                                text: result.detail || 'è«‹æª¢æŸ¥è¼¸å…¥çš„è³‡æ–™æ˜¯å¦æ­£ç¢º'
                            });
                        }
                        
                    } catch (error) {
                        console.error('æ›´æ–°å€‹äººè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'æ›´æ–°å¤±æ•—',
                            text: 'ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'
                        });
                    } finally {
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });

        // é€šçŸ¥ä¸­å¿ƒåŠŸèƒ½
        let notifications = [];
        let unreadCount = 0;

        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    notifications = [];
                    unreadCount = 0;
                }
            } catch (error) {
                console.error('è¼‰å…¥é€šçŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                notifications = [];
                unreadCount = 0;
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification && !notification.is_read) {
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        updateNotificationStatus();
                    }
                }
            } catch (error) {
                console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', error);
            }
        }

        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) return;
            
            if (notificationCenter.style.display === 'block') {
                notificationCenter.style.display = 'none';
            } else {
                notificationCenter.style.display = 'block';
                await loadNotifications();
                updateNotifications();
            }
        }

        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.classList.add('has-unread');
            } else {
                notificationLink.classList.remove('has-unread');
            }
        }

        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;
            
            updateNotificationStatus();
            notificationList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<li class="notification-item" style="text-align: center; color: #999;"><div class="notification-content">æš«ç„¡é€šçŸ¥</div></li>';
                return;
            }
            
            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = `notification-item ${!notification.is_read ? 'unread' : ''}`;
                
                const typeIcon = {
                    'order_accepted': 'âœ…', 'order_rejected': 'âŒ', 'order_status_update': 'ğŸ”„',
                    'order_ready': 'ğŸ½ï¸', 'order_completed': 'âœ…', 'new_order': 'ğŸ“‹',
                    'new_review': 'â­', 'review_reply': 'ğŸ’¬', 'order_negotiation': 'ğŸ’°',
                    'negotiation_response': 'ğŸ’¬'
                };
                
                const icon = typeIcon[notification.type] || 'ğŸ“¢';
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºè¨‚å–®é¡é€šçŸ¥ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                    }
                    if (notification.order_id) {
                        window.location.href = `/customer/order/${notification.order_id}`;
                    }
                });
                
                notificationList.appendChild(li);
            });
        }

        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                }
            } catch (error) {
                console.error('ç²å–æœªè®€æ•¸é‡å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–é€šçŸ¥ä¸­å¿ƒ
        document.addEventListener('DOMContentLoaded', async function() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (notificationCenter) {
                notificationCenter.style.display = 'none';
            }
            
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
            
            setInterval(async () => { await getUnreadCount(); }, 30000);
        });
    </script>
</body>
</html>

