<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cactus+Classical+Serif&family=Noto+Sans+HK:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap" rel="stylesheet">
    <link href="/static/css/reserve2.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Step2 - 菜單填寫</title>
</head>

<body>
    <div class="navbar">
        <div class="site-name">味你而煮</div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            {% if user %}
            <a href="/customer/cooking_method">料理方式建議</a>
            <a href="{{ url_for('order_step0') }}">新增訂單</a>
            <a href="{{ url_for('customer_order_list') }}">我的訂單</a>
            <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
            {% else %}
            <a href="{{ url_for('index') }}">關於我們</a>
            <a href="{{ url_for('index') }}">料理方式建議</a>
            <a href="{{ url_for('index') }}">常見問題</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>

    <div class="content">
        <div class="section">
            <h3>Step2 - 菜單填寫</h3>
            <form id="step2-form" action="{{ url_for('order_step2') }}" method="post" onsubmit="handleStep2Submit(event)">
                <table id="menu-table">
                    <tr id="dish-section-1">
                        <td>
                            <div>
                                <label class="bold-text">第 <span id="dish-index">1</span> 道餐點</label><br>
                                <input type="text" id="dish-name" placeholder="請填寫餐點名稱" required />
                            </div>
                            <br>
                            <div class="custom-number-input">
                                <label class="bold-text">分量：</label>
                                <input type="number" id="custom-number" min="1" max="100" step="1" value="1" required />
                                <span>人份</span>
                            </div>
                            <br>
                            <div>
                                <label class="bold-text">需要的食材</label><br>
                                <input type="text" id="ingredients" placeholder="請填寫需要的食材" />
                            </div>
                            <br>
                            <div>
                                <label class="bold-text">特製作法</label><br>
                                <button class="cookingmethod-button" type="button" data-value="0">紅燒</button>
                                <button class="cookingmethod-button" type="button" data-value="1">清蒸</button>
                                <button class="cookingmethod-button" type="button" data-value="2">油煎</button>
                                <button class="cookingmethod-button" type="button" data-value="3">川燙</button>
                                <input type="text" id="special" placeholder="請提供您需要的特製作法給廚師" />
                            </div>
                        </td>
                        <td>
                            <div>
                                <label class="bold-text">調味</label>
                            </div>
                            <div class="salinity-container">
                                <label>鹹度：</label>
                                <button class="salinity-button" type="button" data-value="light">極淡</button>
                                <button class="salinity-button" type="button" data-value="light">清淡</button>
                                <button class="salinity-button active" type="button" data-value="normal">標準</button>
                                <button class="salinity-button" type="button" data-value="heavy">濃郁</button>
                            </div>
                            <div class="spiciness-container">
                                <label>辣度：</label>
                                <button class="spiciness-button active" type="button" data-value="none">不辣</button>
                                <button class="spiciness-button" type="button" data-value="mild">小辣</button>
                                <button class="spiciness-button" type="button" data-value="medium">中辣</button>
                                <button class="spiciness-button" type="button" data-value="spicy">大辣</button>
                            </div>
                            <div class="oillevel-container">
                                <label>油度：</label>
                                <button class="oillevel-button" type="button" data-value="0">低油</button>
                                <button class="oillevel-button" type="button" data-value="5">少油</button>
                                <button class="oillevel-button" type="button" data-value="10">標準</button>
                            </div>
                            <br>
                            <div>
                                <label class="bold-text">客製備註</label><br>
                                <input type="text" id="customized" placeholder="請填寫需要的備註事項" />
                            </div>
                            <br>
                            <div class="button-container">
                                <button class="back" type="button" onclick="goToPreviousDish()">⭠</button>
                                <button class="next" type="button" onclick="goToNextDish()">⭢</button>
                                <button class="delete-button" type="button" onclick="deleteDish()">刪除</button>
                                <button class="next-button" type="button" onclick="updateDish()">新增下一道</button>
                                <button class="save-button" type="submit">菜單確認</button>
                            </div>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <div class="progress-bar">
        <div class="step">選擇廚師</div>
        <div class="line"></div>
        <div class="step">第1步</div>
        <div class="line"></div>
        <div class="step active">第2步</div>
        <div class="line"></div>
        <div class="step">第3步</div>
        <div class="line"></div>
        <div class="step">第4步</div>
    </div>

    <div class="settings-modal" id="settings-modal">
        <div class="modal-content">
            <h2>設定</h2>
            <p>帳號：</p>
            <p>其他</p>
            <button class="close-btn" onclick="toggleSettingsModal()">儲存</button>
        </div>
    </div>

    <script>
        let dishCount = 1;
        let currentDishIndex = 1;
        let dishData = {};

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('dishData');
            if (saved) {
                dishData = JSON.parse(saved);
                dishCount = Object.keys(dishData).length;
                renderDish();
            }
        });

        function saveCurrentDishData() {
            const name = document.getElementById('dish-name').value;
            const portion = parseInt(document.getElementById('custom-number').value) || 1;
            const ingredients = document.getElementById('ingredients').value;
            const special = document.getElementById('special').value;
            const customized = document.getElementById('customized').value;
            const salinity = document.querySelector('.salinity-button.active')?.dataset.value || 'normal';
            const spiciness = document.querySelector('.spiciness-button.active')?.dataset.value || 'none';
            const oilLevel = parseInt(document.querySelector('.oillevel-button.active')?.dataset.value) || 0;
            const aroma = parseInt(document.querySelector('.aroma-button.active')?.dataset.value) || 0;

            dishData[currentDishIndex] = { name, portion, ingredients, special, customized, salinity, spiciness, oilLevel, aroma };
            localStorage.setItem('dishData', JSON.stringify(dishData));
        }

        function renderDish() {
            document.getElementById('dish-index').textContent = currentDishIndex;
            const d = dishData[currentDishIndex] || {};
            document.getElementById('dish-name').value = d.name || '';
            document.getElementById('custom-number').value = d.portion || 1;
            document.getElementById('ingredients').value = d.ingredients || '';
            document.getElementById('special').value = d.special || '';
            document.getElementById('customized').value = d.customized || '';
            ['salinity','spiciness','oilLevel','aroma'].forEach(type => {
                document.querySelectorAll(`.${type}-button`).forEach(b => b.classList.remove('active'));
                document.querySelector(`.${type}-button[data-value='${d[type]}']`)?.classList.add('active');
            });
        }

        function handleStep2Submit(e) {
            e.preventDefault();
            saveCurrentDishData();
            const form = document.getElementById('step2-form');
            form.querySelectorAll('.dynamic-hidden').forEach(el => el.remove());
            Object.values(dishData).forEach(d => {
                const fields = {
                    dish_names: d.name,
                    quantities: d.portion,
                    unit_prices: d.price || 0,
                    salt_levels: d.salinity,
                    spice_levels: d.spiciness,
                    include_onions: true,
                    include_gingers: true,
                    include_garlics: true,
                    include_cilantros: true,
                    ingredients_list: d.ingredients,
                    special_instructions_list: d.special,
                    custom_notes_list: d.customized
                };
                Object.entries(fields).forEach(([key,val]) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = String(val);
                    input.classList.add('dynamic-hidden');
                    form.appendChild(input);
                });
            });
            form.submit();
        }

        ['salinity','spiciness','oillevel','aroma','cookingmethod'].forEach(type => {
            document.querySelectorAll(`.${type}-button`).forEach(btn =>
                btn.addEventListener('click', function() {
                    document.querySelectorAll(`.${type}-button`).forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    saveCurrentDishData();
                })
            );
        });
        
        function updateDish() {
            saveCurrentDishData();
            dishCount++;
            currentDishIndex = dishCount;
            renderDish();
        }

        function goToNextDish() { saveCurrentDishData(); if (currentDishIndex < dishCount) currentDishIndex++, renderDish(); else Swal.fire('已經是最後一道菜'); }
        function goToPreviousDish() { saveCurrentDishData(); if (currentDishIndex > 1) currentDishIndex--, renderDish(); else Swal.fire('已經是第一道菜'); }
        function deleteDish() { Swal.fire({ title:'確定刪除?', icon:'warning', showCancelButton:true }).then(res=>{ if(res.isConfirmed){ delete dishData[currentDishIndex]; const vals=Object.values(dishData); dishData={}; vals.filter(x=>x).forEach((x,i)=>dishData[i+1]=x); dishCount=Object.keys(dishData).length; if(currentDishIndex>dishCount) currentDishIndex=dishCount; renderDish(); localStorage.setItem('dishData',JSON.stringify(dishData)); }}); }
        function toggleNotification(){const m=document.getElementById('notificationCenter'); m.style.display=m.style.display==='flex'?'none':'flex';}
    </script>
    <script src="/static/js/notification.js"></script>
</body>

</html>