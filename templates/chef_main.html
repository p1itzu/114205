<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='css/ChefMain.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/notification.css') }}">
    <title>å»šå¸«ç®¡ç†é é¢ - å‘³ä½ è€Œç…®</title>
    <script>
        function generateCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
            document.getElementById("calendar-header").innerText = monthNames[month] + " " + year;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let calendarHTML = "<div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>";
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += "<div></div>";
            }
            for (let day = 1; day <= daysInMonth; day++) {
                calendarHTML += `<div>${day}</div>`;
            }
            document.getElementById("calendar").innerHTML = calendarHTML;
        }

        function editProfile() {
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function showFoodPhotos() {
            document.getElementById('foodPhotosModal').style.display = 'block';
        }

        function closeFoodPhotosModal() {
            document.getElementById('foodPhotosModal').style.display = 'none';
        }

        function toggleDropdown() {
            document.getElementById("orderDropdown").classList.toggle("show");
        }

        // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚é—œé–‰ä¸‹æ‹‰é¸å–®
        window.onclick = function (event) {
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // æäº¤ç·¨è¼¯è¡¨å–®
        async function submitEdit(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('editForm'));
            
            try {
                const response = await fetch('/chef/profile/update', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
                    location.reload();
                } else {
                    alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            } catch (error) {
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        window.onload = function () {
            generateCalendar();
        };
    </script>
</head>

<body>
    <div class="container">
        <div class="navbar">
            <div class="site-name">å‘³ä½ è€Œç…®</div>
            <div class="nav-links">
                <a href="{{ url_for('chef_dashboard') }}">é¦–é </a>
                <a href="{{ url_for('chef_main') }}">æˆ‘çš„é é¢</a>
                <a href="{{ url_for('chef_pending_orders') }}">å¾…æ¥å–®è¨‚å–®</a>

                <!-- ä¸‹æ‹‰é¸å–® -->
                <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleDropdown()">æˆ‘çš„è¨‚å–® â–¾</button>
                    <div class="dropdown-content" id="orderDropdown">
                        <a href="{{ url_for('chef_accepted_orders') }}">å¾…å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_completed_orders') }}">å·²å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}">è­°åƒ¹ä¸­è¨‚å–®</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}">å·²å–æ¶ˆè¨‚å–®</a>
                    </div>
                </div>

                <a href="#contact">å®¢æœè¯çµ¡</a>
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
            </div>
            <div class="user-info">
                <img src="{{ current_user.avatar_url or url_for('static', path='imgs/chef.png') }}" alt="é ­åƒ" class="avatar" />
                <div class="user-text">
                    <div class="name">{{ current_user.name }}</div>
                    <div class="email">{{ current_user.email }}</div>
                </div>
                <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            </div>
        </div>

        <div class="content">
            <div class="box profile">
                <div class="profile-content">
                    <button class="edit-button" onclick="editProfile()">ç·¨è¼¯</button>
                    <div class="profile-image">
                        <img id="chef-photo" src="{{ current_user.avatar_url or url_for('static', path='imgs/chef.png') }}" alt="å»šå¸«ç…§ç‰‡">
                    </div>
                    <div class="profile-text">
                        <h2 id="chef-name">{{ current_user.name }}</h2>
                        <p><strong>è¯çµ¡æ–¹å¼ï¼š</strong>{{ current_user.phone or 'æœªè¨­å®š' }}</p>
                        <p><strong>å»šæˆ¿åœ°å€ï¼š</strong>{{ chef_profile.kitchen_address or 'æœªè¨­å®š' }}</p>
                        <p><strong>å°ˆæ¥­è­‰ç…§ï¼š</strong>
                            {% if chef_profile.certificate_name %}
                                <span class="underline">{{ chef_profile.certificate_name }}</span>
                                {% if chef_profile.certificate_verified %}
                                    <span class="verified">âœ“ å·²èªè­‰</span>
                                {% else %}
                                    <span class="pending">â³ å¾…å¯©æ ¸</span>
                                {% endif %}
                            {% else %}
                                æœªè¨­å®š
                            {% endif %}
                        </p>
                        <p><strong>æ–™ç†å°ˆé•·ï¼š</strong>
                            {% if chef_specialties %}
                                {% for specialty in chef_specialties %}
                                    <span class="specialty-tag">{{ specialty.specialty }}</span>
                                {% endfor %}
                            {% else %}
                                æœªè¨­å®š
                            {% endif %}
                        </p>
                        <p><strong>æ‹›ç‰Œèœï¼š</strong>
                            {% if signature_dishes %}
                                {% for dish in signature_dishes %}
                                    {{ dish.dish_name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                æœªè¨­å®š
                            {% endif %}
                        </p>
                        <p><strong>ç¶“é©—å¹´æ•¸ï¼š</strong>{{ chef_profile.experience_years or 'æœªè¨­å®š' }}å¹´</p>
                        <p><strong>å¹³å‡è©•åˆ†ï¼š</strong>
                            {% if chef_profile.average_rating > 0 %}
                                â­ {{ "%.1f"|format(chef_profile.average_rating) }} ({{ chef_profile.total_reviews }}å‰‡è©•åƒ¹)
                            {% else %}
                                æš«ç„¡è©•åƒ¹
                            {% endif %}
                        </p>
                        <p><strong>é£Ÿç‰©ç…§ï¼š</strong></p>
                        <button class="view-photos-btn" onclick="showFoodPhotos()">æŸ¥çœ‹ä¸Šå‚³ç…§ç‰‡</button>
                    </div>
                </div>
            </div>

            <div class="box square-box notifications">
                <div class="notification-icon">ğŸ””</div>
                <h3>æœ€æ–°é€šçŸ¥</h3>
                <ul>
                    {% if notifications %}
                        {% for notification in notifications %}
                            <li><a href="#">{{ notification.message }}</a></li>
                        {% endfor %}
                    {% else %}
                        <li>æš«ç„¡æ–°é€šçŸ¥</li>
                    {% endif %}
                </ul>
            </div>

            <div class="right-section">
                <div class="box square-box calendar-box">
                    <div class="calendar-header" id="calendar-header"></div>
                    <div id="calendar" class="calendar"></div>
                </div>
                <div class="orders">
                    <h3>ä»Šæ—¥è¨‚å–®</h3>
                    {% if recent_orders %}
                        {% for order in recent_orders %}
                            <div class="order-item">
                                <a href="{{ url_for('chef_order_detail', order_id=order.id) }}">
                                    è¨‚å–®ç·¨è™Ÿ #{{ order.order_number }}
                                </a>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="order-item">æš«ç„¡è¨‚å–®</div>
                    {% endif %}
                </div>
            </div>

            <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
            <div id="editModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeEditModal()">&times;</span>
                    <h2>ç·¨è¼¯ç°¡ä»‹</h2>
                    <form id="editForm" onsubmit="submitEdit(event)">
                        <label for="name">å§“åï¼š</label>
                        <input type="text" id="name" name="name" value="{{ current_user.name }}" required><br><br>
                        
                        <label for="phone">è¯çµ¡æ–¹å¼ï¼š</label>
                        <input type="text" id="phone" name="phone" value="{{ current_user.phone or '' }}"><br><br>
                        
                        <label for="kitchen_address">å»šæˆ¿åœ°å€ï¼š</label>
                        <input type="text" id="kitchen_address" name="kitchen_address" value="{{ chef_profile.kitchen_address or '' }}"><br><br>
                        
                        <label for="certificate_name">å°ˆæ¥­è­‰ç…§ï¼š</label>
                        <input type="text" id="certificate_name" name="certificate_name" value="{{ chef_profile.certificate_name or '' }}"><br><br>
                        
                        <label for="specialties">æ–™ç†å°ˆé•·ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š</label>
                        <input type="text" id="specialties" name="specialties" 
                               value="{% for specialty in chef_specialties %}{{ specialty.specialty }}{% if not loop.last %}, {% endif %}{% endfor %}"><br><br>
                        
                        <label for="experience_years">ç¶“é©—å¹´æ•¸ï¼š</label>
                        <input type="number" id="experience_years" name="experience_years" value="{{ chef_profile.experience_years or '' }}" min="0"><br><br>
                        
                        <label for="description">è‡ªæˆ‘ä»‹ç´¹ï¼š</label>
                        <textarea id="description" name="description" rows="4">{{ chef_profile.description or '' }}</textarea><br><br>
                        
                        <label for="photo">ä¸Šå‚³æ–°ç…§ç‰‡ï¼š</label>
                        <input type="file" id="photo" name="photo" accept="image/*"><br><br>
                        
                        <label for="certificate_photo">ä¸Šå‚³è­‰ç…§ï¼š</label>
                        <input type="file" id="certificate_photo" name="certificate_photo" accept="image/*"><br><br>
                        
                        <input type="submit" value="ä¿å­˜">
                    </form>
                </div>
            </div>

            <!-- é£Ÿç‰©ç…§ç‰‡æ¨¡æ…‹æ¡† -->
            <div id="foodPhotosModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeFoodPhotosModal()">&times;</span>
                    <h2>é£Ÿç‰©ç…§ç‰‡</h2>
                    <div class="food-photos-container">
                        {% if signature_dishes %}
                            {% for dish in signature_dishes %}
                                {% if dish.image_url %}
                                    <div class="food-photo-item">
                                        <img src="{{ dish.image_url }}" alt="{{ dish.dish_name }}" style="width: 100%; border-radius: 8px; margin-bottom: 10px;">
                                        <p><strong>{{ dish.dish_name }}</strong></p>
                                        <p>{{ dish.description }}</p>
                                        <p>å»ºè­°åƒ¹æ ¼ï¼š${{ dish.price }}</p>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <p>å°šæœªä¸Šå‚³é£Ÿç‰©ç…§ç‰‡</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå°è¦–çª—ï¼ˆå…±ç”¨ï¼‰ -->
    <div class="settings-modal" id="settings-modal">
        <div class="modal-content">
            <h2 class="title">è¨­å®š</h2>
            <div class="section2">
                <h3>å¸³è™Ÿ</h3>
                <div class="account-info">
                    <img src="{{ current_user.avatar_url or url_for('static', path='imgs/chef.png') }}" alt="Avatar" class="avatar">
                    <div class="account-text">
                        <p class="name">{{ current_user.name }}</p>
                        <p class="sub-text">å€‹äººè³‡æ–™</p>
                    </div>
                </div>
            </div>
            <div class="section2">
                <h3>å…¶ä»–</h3>
                <form action="{{ url_for('logout') }}" method="get" style="display:inline">
                    <button class="logout-btn">
                        <span>â†©ï¸ ç™»å‡º</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ›è¨­å®šè¦–çª—
        function toggleSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            } else {
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
            }
        }

        // é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰
        window.onclick = function (event) {
            const settingsModal = document.getElementById('settings-modal');
            if (event.target === settingsModal) {
                toggleSettingsModal();
            }
        };
    </script>

    <!-- é€šçŸ¥ä¸­å¿ƒçµ„ä»¶ -->
    {% include 'notification_component.html' %}

    <!-- é€šçŸ¥ä¸­å¿ƒ JavaScript -->
    <script>
        // é€šçŸ¥ç³»çµ±è®Šæ•¸
        let notifications = [];
        let unreadCount = 0;

        // è¼‰å…¥é€šçŸ¥è³‡æ–™
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    console.error('è¼‰å…¥é€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¨™è¨˜å·²è®€éŒ¯èª¤:', error);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é€šçŸ¥
        async function clearAllNotifications() {
            try {
                const response = await fetch('/api/notifications/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    notifications = [];
                    unreadCount = 0;
                    updateNotifications();
                    updateNotificationStatus();
                } else {
                    console.error('æ¸…ç©ºé€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¸…ç©ºé€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // å–å¾—æœªè®€é€šçŸ¥æ•¸é‡
        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                } else {
                    console.error('å–å¾—æœªè®€æ•¸é‡å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('å–å¾—æœªè®€æ•¸é‡éŒ¯èª¤:', error);
            }
        }

        // åˆ‡æ›é€šçŸ¥ä¸­å¿ƒé¡¯ç¤ºç‹€æ…‹
        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) {
                console.error('é€šçŸ¥ä¸­å¿ƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (notificationCenter.style.display === 'none' || !notificationCenter.style.display) {
                await loadNotifications();
                updateNotifications();
                notificationCenter.style.display = 'block';
            } else {
                notificationCenter.style.display = 'none';
            }
        }

        // æ›´æ–°é€šçŸ¥é€£çµçš„ç‹€æ…‹ï¼ˆæœªè®€æç¤ºï¼‰
        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.style.position = 'relative';
                notificationLink.innerHTML = `é€šçŸ¥ä¸­å¿ƒ <span style="position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;">${unreadCount}</span>`;
            } else {
                notificationLink.innerHTML = 'é€šçŸ¥ä¸­å¿ƒ';
            }
        }

        // è™•ç†é€šçŸ¥é»æ“Šè·³è½‰
        function handleNotificationClick(notification) {
            let targetUrl = '';
            
            switch(notification.type) {
                case 'new_order':
                    // æ–°è¨‚å–® -> å¾…æ¥å–®é é¢
                    targetUrl = '/chef/pending-orders';
                    break;
                case 'order_completed':
                    // è¨‚å–®å®Œæˆ -> å·²å®Œæˆè¨‚å–®é é¢
                    targetUrl = '/chef/completed-orders';
                    break;
                case 'new_review':
                    // æ–°è©•åƒ¹ -> å»šå¸«å„€è¡¨æ¿ï¼ˆæŸ¥çœ‹è©•åƒ¹ï¼‰
                    targetUrl = '/chef/';
                    break;
                case 'negotiation_response':
                    // è­°åƒ¹å›æ‡‰ -> è­°åƒ¹ä¸­è¨‚å–®é é¢
                    targetUrl = '/chef/negotiating-orders';
                    break;
                case 'order_accepted':
                case 'order_rejected':
                case 'order_ready':
                    // è¨‚å–®ç‹€æ…‹æ›´æ–° -> å°æ‡‰çš„è¨‚å–®è©³æƒ…
                    if (notification.order_id) {
                        targetUrl = `/chef/order/${notification.order_id}`;
                    }
                    break;
                default:
                    // é è¨­è·³è½‰åˆ°å„€è¡¨æ¿
                    targetUrl = '/chef/';
                    break;
            }
            
            if (targetUrl) {
                // é—œé–‰é€šçŸ¥ä¸­å¿ƒ
                const notificationCenter = document.getElementById('notificationCenter');
                if (notificationCenter) {
                    notificationCenter.style.display = 'none';
                }
                // è·³è½‰é é¢
                window.location.href = targetUrl;
            }
        }

        // æ›´æ–°é€šçŸ¥åˆ—è¡¨é¡¯ç¤º
        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;

            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš«ç„¡é€šçŸ¥</div>';
                notificationList.appendChild(li);
                return;
            }

            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                if (!notification.is_read) {
                    li.classList.add('unread');
                }

                // é€šçŸ¥é¡å‹åœ–æ¨™
                const typeIcon = {
                    'new_order': 'ğŸ“‹',
                    'order_completed': 'âœ…',
                    'new_review': 'â­',
                    'negotiation_response': 'ğŸ’¬',
                    'order_accepted': 'âœ…',
                    'order_rejected': 'âŒ',
                    'order_ready': 'ğŸ½ï¸',
                    'review_reply': 'ğŸ’¬'
                };
                const icon = typeIcon[notification.type] || 'ğŸ“¢';

                // åˆ¤æ–·æ˜¯å¦ç‚ºè¨‚å–®é¡é€šçŸ¥ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        li.classList.remove('unread');
                        li.querySelector('.notification-content > div').style.fontWeight = 'normal';
                        updateNotificationStatus();
                    }
                    
                    // æ ¹æ“šé€šçŸ¥é¡å‹è·³è½‰åˆ°å°æ‡‰é é¢
                    handleNotificationClick(notification);
                });

                notificationList.appendChild(li);
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationCenter = document.getElementById('notificationCenter');
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
        });

        // å®šæœŸæ›´æ–°æœªè®€é€šçŸ¥æ•¸é‡
        setInterval(getUnreadCount, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    </script>
</body>
</html> 