<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>議價中訂單 - 味你而煮</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/ChefUnOrder.css') }}">
</head>
<body>
    <div class="navbar">
        <div class="site-name">味你而煮</div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            <a href="{{ url_for('chef_dashboard') }}">總覽</a>
            <a href="{{ url_for('chef_pending_orders') }}">待接單訂單</a>

            <!-- 新增下拉選單 -->
            <div class="dropdown">
                <button class="dropdown-btn" onclick="toggleDropdown()">我的訂單 ▾</button>
                <div class="dropdown-content" id="orderDropdown">
                    <a href="{{ url_for('chef_accepted_orders') }}">待完成訂單</a>
                    <a href="{{ url_for('chef_completed_orders') }}">已完成訂單</a>
                    <a href="{{ url_for('chef_negotiating_orders') }}">議價中訂單</a>
                    <a href="{{ url_for('chef_cancelled_orders') }}">已取消訂單</a>
                </div>
            </div>

            <a href="#">客服聯絡</a>
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>
    
    <div class="search-bar">
        <input type="text" placeholder="搜尋訂單" id="searchInput" onkeyup="searchOrders()">
    </div>
    
    <div class="title-filter-container">
        <div class="maintext">議價中訂單</div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterOrders('newest')">近到遠</button>
            <button class="filter-btn" onclick="filterOrders('oldest')">遠到近</button>
        </div>
    </div>
    
    <div class="container">
        {% if negotiating_orders %}
            {% for order in negotiating_orders %}
            <!-- 檢查是否有待回應的顧客議價 -->
            {% set customer_counter_offer = None %}
            {% for nego in order.negotiations %}
                {% if nego.proposed_by == 'customer' and nego.is_accepted is none %}
                    {% set customer_counter_offer = nego %}
                {% endif %}
            {% endfor %}
            
            <div class="order-card" 
                 data-date="{{ order.preferred_time.strftime('%Y/%m/%d') if order.preferred_time else '' }}"
                 data-order-id="{{ order.id }}"
                 data-has-counter-offer="{{ 'true' if customer_counter_offer else 'false' }}">
                <p><strong>訂單編號</strong><br>#{{ order.order_number }}</p>
                <p>
                    預定日期：{{ order.preferred_time.strftime('%Y/%m/%d') if order.preferred_time else '未指定' }}<br>
                    地區：{{ order.delivery_address.split(' ')[0] if order.delivery_address else '未指定' }}<br>
                    地址：{{ order.delivery_address if order.delivery_address else '未指定' }}<br>
                    狀態：議價中{% if customer_counter_offer %} - 顧客已議價{% endif %}<br>
                    目前報價：NT${{ order.total_amount | int if order.total_amount > 0 else '待議價' }}
                    {% if customer_counter_offer %}<br><span style="color: #dc3545; font-weight: bold;">顧客議價：NT${{ customer_counter_offer.proposed_amount | int }}</span>{% endif %}
                </p>
                <button class="order-btn" onclick="viewOrderDetail(this)">
                    查看訂單詳情
                </button>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-orders">
                <p>目前沒有議價中的訂單</p>
            </div>
        {% endif %}
    </div>

    <script>
        function toggleDropdown() {
            document.getElementById("orderDropdown").classList.toggle("show");
        }

        // 點擊其他地方時關閉下拉選單
        window.onclick = function (event) {
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function viewOrderDetail(buttonElement) {
            const orderCard = buttonElement.closest('.order-card');
            const orderId = orderCard.getAttribute('data-order-id');
            const hasCounterOffer = orderCard.getAttribute('data-has-counter-offer') === 'true';
            
            if (hasCounterOffer) {
                window.location.href = `/chef/order/${orderId}/counter_offer_response`;
            } else {
                window.location.href = `/chef/order/${orderId}`;
            }
        }

        function searchOrders() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const cards = document.getElementsByClassName('order-card');
            
            for (let card of cards) {
                const text = card.textContent.toLowerCase();
                if (text.includes(filter)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            filterOrders('newest');
        });

        function filterOrders(type) {
            const container = document.querySelector('.container');
            const cards = Array.from(container.getElementsByClassName('order-card'));
            const filterButtons = document.querySelectorAll('.filter-btn');

            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (type === 'newest' ? '近到遠' : '遠到近')) {
                    btn.classList.add('active');
                }
            });

            const cardsWithDates = cards.map(card => {
                const dateStr = card.getAttribute('data-date');
                let timestamp = 0;
                if (dateStr) {
                    const [year, month, day] = dateStr.split('/');
                    timestamp = new Date(year, parseInt(month) - 1, day).getTime();
                }
                
                return {
                    element: card,
                    timestamp: timestamp
                };
            });

            cardsWithDates.sort((a, b) => {
                if (type === 'newest') {
                    return b.timestamp - a.timestamp;
                } else {
                    return a.timestamp - b.timestamp;
                }
            });

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            cardsWithDates.forEach(item => {
                container.appendChild(item.element);
            });
        }
    </script>
</body>
</html> 