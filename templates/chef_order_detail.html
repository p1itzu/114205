<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
    <title>è¨‚å–®ç¢ºèª - å‘³ä½ è€Œç…®</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/Order.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/notification.css') }}">
    
    <style>
        /* Navbar æ¨£å¼ä¿®æ­£ */
        .navbar .site-name {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .navbar .site-logo {
            width: 35px !important;
            height: 35px !important;
            object-fit: contain !important;
        }
        
        .navbar .site-text {
            display: flex !important;
            flex-direction: column !important;
            gap: 0px !important;
        }
        
        .navbar .site-title {
            font-size: 20px !important;
            font-weight: bold !important;
            color: #B3811C !important;
            line-height: 1.2 !important;
        }
        
        .navbar .site-subtitle {
            font-size: 12px !important;
            font-weight: normal !important;
            color: #B3811C !important;
            opacity: 0.8 !important;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        /* ç”¨æˆ¶é ­åƒå¤§å°é™åˆ¶ */
        .navbar .user-info .avatar {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            margin-right: 10px !important;
        }
        
        .user-info .name {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #B3811C !important;
        }
        
        .user-info .email {
            font-size: 16px !important;
            color: #8B6014 !important;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">å‘³ä½ è€Œç…®</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">é¦–é </a>
            {% if current_user %}
                {% if current_user.role and current_user.role.value == 'chef' %}
                <!-- å»šå¸«å°ˆç”¨å°èˆª -->
                <a href="{{ url_for('chef_dashboard') }}">ç¸½è¦½</a>
                <a href="{{ url_for('chef_pending_orders') }}">å¾…æ¥å–®è¨‚å–®</a>
                
                <!-- å»šå¸«çš„æˆ‘çš„è¨‚å–®ä¸‹æ‹‰é¸å–® -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">æˆ‘çš„è¨‚å–® â–¾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å¾…å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">è­°åƒ¹ä¸­è¨‚å–®</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å–æ¶ˆè¨‚å–®</a>
                    </div>
                </div>
                
                <a href="#">å®¢æœè¯çµ¡</a>
                {% else %}
                <!-- é¡§å®¢å°ˆç”¨å°èˆª -->
                <a href="/customer/cooking_method">æ–™ç†æ–¹å¼å»ºè­°</a>
                <a href="{{ url_for('order_step0') }}">æ–°å¢è¨‚å–®</a>
                <a href="{{ url_for('customer_order_list') }}">æˆ‘çš„è¨‚å–®</a>
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">é—œæ–¼æˆ‘å€‘</a>
            <a href="{{ url_for('index') }}">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('index') }}">å¸¸è¦‹å•é¡Œ</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if current_user %}
            <img
                src="{{ current_user.avatar_url or '/static/imgs/avatar.png' }}"
                alt="é ­åƒ"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ current_user.name }}</div>
                <div class="email">{{ current_user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">ç™»å…¥/è¨»å†Š</a>
            {% endif %}
        </div>
    </div>
    
    <div class="container">
        <div class="back-button" onclick="goBack()">â† è¿”å›</div>
        <div class="title">è¨‚å–®ç·¨è™Ÿ #{{ order.order_number }}</div>
        <div class="content">
            <p><strong>é ç´„æ—¥æœŸèˆ‡æ™‚é–“ï¼š{{ order.preferred_time.strftime('%Y/%m/%d %H:%M') if order.preferred_time else 'æœªæŒ‡å®š' }}</strong></p>
            <p><strong>å–é¤æ–¹å¼ï¼š{{ 'å¤–é€' if order.delivery_method.value == 'delivery' else 'è‡ªå–' }}</strong></p>
            <p><strong>è¯çµ¡äººè³‡è¨Šï¼š{{ order.customer.email }}</strong></p>
            <p><strong>è¯çµ¡é›»è©±ï¼š{{ order.customer.phone if order.customer.phone else 'æœªæä¾›' }}</strong></p>
            
            {% if order.customer_notes %}
            <p><strong>å®¢æˆ¶å‚™è¨»ï¼š</strong>{{ order.customer_notes }}</p>
            {% endif %}
            
            <hr>
            <p><strong>èœå–®åˆ—è¡¨ï¼š</strong></p>
            
            {% for dish in order.dishes %}
            <p><strong>{{ loop.index }}. {{ dish.dish_name }} {{ dish.quantity }}äººä»½</strong></p>
            <p>ï¼ˆé¹¹åº¦:{{ dish.salt_level.value | replace('light', 'æ¸…æ·¡') | replace('normal', 'æ­£å¸¸') | replace('heavy', 'é‡é¹¹') }} 
               è¾£åº¦:{{ dish.spice_level.value | replace('none', 'ä¸è¾£') | replace('mild', 'å¾®è¾£') | replace('medium', 'ä¸­è¾£') | replace('spicy', 'è¾£') | replace('very_spicy', 'è¶…è¾£') }} 
               ï¼‰</p>
            
            {% if dish.ingredients %}
            <p>é£Ÿæï¼š{{ dish.ingredients }}</p>
            {% endif %}
            
            {% if dish.custom_notes %}
            <p>å®¢è£½åŒ–è£œå……ï¼š{{ dish.custom_notes }}</p>
            {% endif %}
            
            {% if dish.special_instructions %}
            <p>åšæ³•ï¼š{{ dish.special_instructions }}</p>
            {% endif %}
            
            {% if not loop.last %}<br>{% endif %}
            {% endfor %}

        </div>
        
        {% if order.status.value == 'pending' %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold;">è«‹ç¢ºèªæ˜¯å¦è¦æ¥å–®ï¼Ÿ</p>
        <div class="buttons">
            <button class="reject" onclick="rejectOrder()">æ‹’çµ•</button>
            <button class="accept" type="button" onclick="acceptOrder()">æ¥å–®</button>
        </div>
        
        {% elif order.status.value == 'negotiating' %}
        <!-- æª¢æŸ¥æ˜¯å¦æœ‰æœ€çµ‚å®šåƒ¹ç­‰å¾…é¡§å®¢å›æ‡‰ -->
        {% if chef_final_pricing_pending %}
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4 style="color: #856404;">â³ ç­‰å¾…é¡§å®¢å›æ‡‰æœ€çµ‚å®šåƒ¹</h4>
            <p style="color: #856404;">æ‚¨å·²æäº¤æœ€çµ‚å®šåƒ¹ï¼Œè«‹è€å¿ƒç­‰å¾…é¡§å®¢å›æ‡‰ã€‚åœ¨æ­¤æœŸé–“ç„¡æ³•ä¿®æ”¹è¨‚å–®ã€‚</p>
            {% for nego in order.negotiations %}
                {% if nego.proposed_by == 'chef' and nego.is_accepted is none %}
                <p style="color: #856404;"><strong>æœ€çµ‚å®šåƒ¹ï¼šNT${{ nego.proposed_amount | int }}</strong></p>
                {% if nego.message %}
                <p style="color: #856404;">èªªæ˜ï¼š{{ nego.message }}</p>
                {% endif %}
                {% endif %}
            {% endfor %}
        </div>
        
        {% else %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold; color: #FF8C00;">
            è¨‚å–®é€²å…¥è­°åƒ¹éšæ®µï¼ˆ{{ order.negotiation_count }}/2 æ¬¡è­°åƒ¹ï¼‰
        </p>
        
        <!-- é¡¯ç¤ºè­°åƒ¹æ­·å² -->
        {% if order.negotiations %}
        <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
            <h4>è­°åƒ¹è¨˜éŒ„ï¼š</h4>
            {% for nego in order.negotiations %}
            <div style="border-left: 3px solid #007bff; padding: 10px; margin: 10px 0; background: white;">
                <p><strong>{{ 'å»šå¸«' if nego.proposed_by == 'chef' else 'é¡§å®¢' }}æè­°ï¼š</strong> NT${{ nego.proposed_amount | int }}</p>
                {% if nego.message %}<p><strong>èªªæ˜ï¼š</strong>{{ nego.message }}</p>{% endif %}
                <p><strong>æ™‚é–“ï¼š</strong>{{ nego.created_at.strftime('%m/%d %H:%M') }}</p>
                {% if nego.is_accepted is not none %}
                <p><strong>ç‹€æ…‹ï¼š</strong>
                    {% if nego.is_accepted %}
                    <span style="color: green;">å·²æ¥å—</span>
                    {% else %}
                    <span style="color: red;">å·²æ‹’çµ•</span>
                    {% endif %}
                </p>
                {% if nego.response_message %}<p><strong>å›æ‡‰ï¼š</strong>{{ nego.response_message }}</p>{% endif %}
                {% else %}
                <p><strong>ç‹€æ…‹ï¼š</strong><span style="color: orange;">ç­‰å¾…å›æ‡‰</span></p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- è­°åƒ¹æ“ä½œ -->
        {% if order.negotiation_count < 2 %}
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4>æå‡ºè­°åƒ¹ï¼š</h4>
            <form id="negotiation-form" style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                    <label>å»ºè­°é‡‘é¡ï¼š</label>
                    <input type="number" id="proposed-amount" step="0.01" min="0" placeholder="è«‹è¼¸å…¥å»ºè­°é‡‘é¡" required style="width: 200px; padding: 5px;">
                </div>
                <div>
                    <label>è­°åƒ¹èªªæ˜ï¼š</label>
                    <textarea id="negotiation-message" placeholder="èªªæ˜è­°åƒ¹åŸå› ï¼ˆé¸å¡«ï¼‰" style="width: 100%; padding: 5px; height: 60px;"></textarea>
                </div>
                <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    æå‡ºè­°åƒ¹
                </button>
            </form>
        </div>
        {% else %}
        <p style="text-align: center; margin-top: 15px; color: #dc3545;">
            å·²é”æœ€å¤§è­°åƒ¹æ¬¡æ•¸ï¼Œç­‰å¾…é¡§å®¢å›æ‡‰
        </p>
        {% endif %}
        
        <!-- æª¢æŸ¥æ˜¯å¦æœ‰è¢«æ¥å—çš„è­°åƒ¹ -->
        {% set accepted_nego = None %}
        {% set customer_counter_offer = None %}
        {% for nego in order.negotiations %}
            {% if nego.is_accepted %}
                {% set accepted_nego = nego %}
            {% elif nego.proposed_by == 'customer' and (nego.is_accepted is none or nego.is_accepted is null or nego.is_accepted == None) %}
                {% set customer_counter_offer = nego %}
            {% endif %}
        {% endfor %}
        
        {% if customer_counter_offer %}
        <!-- é¡¯ç¤ºé¡§å®¢çš„å†è­°åƒ¹ -->
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4 style="color: #856404;">é¡§å®¢å†è­°åƒ¹ï¼šNT${{ customer_counter_offer.proposed_amount | int }}</h4>
            {% if customer_counter_offer.message %}
            <p style="color: #856404; margin: 10px 0;">é¡§å®¢èªªæ˜ï¼š{{ customer_counter_offer.message }}</p>
            {% endif %}
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <a href="{{ url_for('chef_counter_offer_response', order_id=order.id) }}" 
                   style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; text-decoration: none; display: inline-block;">
                    å‰å¾€è­°åƒ¹å›æ‡‰é é¢
                </a>
                <button class="accept-counter-offer" data-negotiation-id="{{ customer_counter_offer.id }}" 
                        style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    å¿«é€Ÿæ¥å—è­°åƒ¹
                </button>
                <button class="reject-counter-offer" data-negotiation-id="{{ customer_counter_offer.id }}" 
                        style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    æ‹’çµ•è­°åƒ¹ï¼ˆå–æ¶ˆè¨‚å–®ï¼‰
                </button>
            </div>
        </div>
        {% elif accepted_nego %}
        <div style="background: #d4edda; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #c3e6cb;">
            <p style="color: #155724; font-weight: bold;">é¡§å®¢å·²æ¥å—è­°åƒ¹ï¼šNT${{ accepted_nego.proposed_amount | int }}</p>
            <button onclick="confirmNegotiation()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                ç¢ºèªé–‹å§‹è£½ä½œ
            </button>
        </div>
        {% endif %}
        {% endif %}
        
        {% else %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold; color: #666;">
            æ­¤è¨‚å–®ç‹€æ…‹ï¼š{{ order.status.value | replace('accepted', 'å·²æ¥å–®') | replace('preparing', 'è£½ä½œä¸­') | replace('ready', 'è£½ä½œå®Œæˆ') | replace('completed', 'å·²å®Œæˆ') | replace('cancelled', 'å·²å–æ¶ˆ') | replace('negotiating', 'è­°åƒ¹ä¸­') | replace('pending', 'ç­‰å¾…å›æ‡‰') }}
        </p>
        
        {% if order.status.value == 'accepted' %}
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="markOrderReady()" style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                é¤é»è£½ä½œå®Œæˆ
            </button>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <!-- æ·»åŠ è³‡æ–™å±¬æ€§ -->
    {% set has_customer_counter = false %}
    {% for nego in order.negotiations %}
        {% if nego.proposed_by == 'customer' and (nego.is_accepted is none or nego.is_accepted is null or nego.is_accepted == None) %}
            {% set has_customer_counter = true %}
        {% endif %}
    {% endfor %}
    
    <!-- èª¿è©¦ï¼šé¡¯ç¤ºæ¯å€‹è­°åƒ¹è¨˜éŒ„çš„è©³ç´°ä¿¡æ¯ -->
    <div id="debug-info" style="display: none;">
        {% for nego in order.negotiations %}
        <div data-nego-id="{{ nego.id }}" 
             data-proposed-by="{{ nego.proposed_by }}" 
             data-is-accepted="{{ nego.is_accepted if nego.is_accepted is not none else 'null' }}"
             data-amount="{{ nego.proposed_amount }}"></div>
        {% endfor %}
    </div>
    
    <div id="page-data" 
         data-has-counter-offer="{{ 'true' if has_customer_counter else 'false' }}"
         data-counter-offer-url="{{ url_for('chef_counter_offer_response', order_id=order.id) }}"
         data-order-id="{{ order.id }}"
         style="display: none;"></div>

    <script>
        // èª¿è©¦ä¿¡æ¯ï¼šæª¢æŸ¥æ‰€æœ‰è­°åƒ¹è¨˜éŒ„
        const debugInfo = document.getElementById('debug-info');
        const negoElements = debugInfo.querySelectorAll('[data-nego-id]');
        console.log('=== è­°åƒ¹è¨˜éŒ„èª¿è©¦ ===');
        negoElements.forEach(elem => {
            console.log('è­°åƒ¹è¨˜éŒ„:', {
                id: elem.getAttribute('data-nego-id'),
                proposed_by: elem.getAttribute('data-proposed-by'),
                is_accepted: elem.getAttribute('data-is-accepted'),
                amount: elem.getAttribute('data-amount')
            });
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å¾…å›æ‡‰çš„é¡§å®¢è­°åƒ¹
        const pageData = document.getElementById('page-data');
        const hasCounterOffer = pageData.getAttribute('data-has-counter-offer') === 'true';
        const orderStatus = '{{ order.status.value }}';
        
        console.log('è‡ªå‹•è·³è½‰æª¢æŸ¥ - æœ‰é¡§å®¢è­°åƒ¹:', hasCounterOffer, 'è¨‚å–®ç‹€æ…‹:', orderStatus);
        
        // æ‰‹å‹•æª¢æŸ¥æ˜¯å¦æœ‰æœªå›æ‡‰çš„é¡§å®¢è­°åƒ¹
        let manualCheck = false;
        negoElements.forEach(elem => {
            const proposedBy = elem.getAttribute('data-proposed-by');
            const isAccepted = elem.getAttribute('data-is-accepted');
            if (proposedBy === 'customer' && (isAccepted === 'null' || isAccepted === 'None' || isAccepted === '')) {
                manualCheck = true;
                console.log('æ‰‹å‹•æª¢æŸ¥ç™¼ç¾æœªå›æ‡‰çš„é¡§å®¢è­°åƒ¹:', elem.getAttribute('data-nego-id'));
            }
        });
        
        console.log('æ‰‹å‹•æª¢æŸ¥çµæœ:', manualCheck);
        
        if ((hasCounterOffer || manualCheck) && orderStatus === 'negotiating') {
            const counterOfferUrl = pageData.getAttribute('data-counter-offer-url');
            console.log('æº–å‚™è·³è½‰åˆ°:', counterOfferUrl);
            
            // ç›´æ¥è·³è½‰åˆ°è­°åƒ¹å›æ‡‰é é¢ï¼ˆç§»é™¤æç¤ºï¼‰
            window.location.href = counterOfferUrl;
        }
        
        // åˆ‡æ›è¨­å®šè¦–çª—
        function toggleSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        // ä¸‹æ‹‰é¸å–®åˆ‡æ›åŠŸèƒ½
        function toggleDropdown() {
            var dropdown = document.getElementById("orderDropdown");
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
            } else {
                dropdown.style.display = "block";
            }
        }

        // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®å’Œè¨­å®šè¦–çª—
        window.addEventListener('click', function(event) {
            // é—œé–‰ä¸‹æ‹‰é¸å–®
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.style.display === "block") {
                        openDropdown.style.display = "none";
                    }
                }
            }
            
            // é—œé–‰è¨­å®šè¦–çª—
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
        });

        function goBack() {
            window.history.back();
        }
        
        function acceptOrder() {
            // ç™¼é€æ¥å–®è«‹æ±‚
            fetch(`/chef/order/{{ order.id }}/accept`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "æ¥å–®æˆåŠŸï¼",
                        text: "è«‹é€²è¡Œåƒ¹æ ¼ä¼°ç®—",
                        icon: "success",
                        confirmButtonText: "ç«‹å³å‰å¾€ä¼°åƒ¹",
                        showCancelButton: true,
                        cancelButtonText: "ç¨å¾Œè™•ç†",
                        customClass: {
                            confirmButton: "swal-custom-button",
                            cancelButton: "swal-custom-cancel"
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // è·³è½‰åˆ°ä¼°åƒ¹é é¢
                            window.location.href = data.redirect_url || `/chef/order/{{ order.id }}/pricing`;
                        } else {
                            // è·³è½‰åˆ°å¾…æ¥å–®é é¢
                            window.location.href = "{{ url_for('chef_pending_orders') }}";
                        }
                    });
                } else {
                    Swal.fire({
                        title: "æ¥å–®å¤±æ•—",
                        text: data.message,
                        icon: "error"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "æ¥å–®å¤±æ•—",
                    text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                    icon: "error"
                });
            });
        }
        
        function rejectOrder() {
            Swal.fire({
                title: "ç¢ºå®šæ‹’çµ•æ­¤å–®",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "å¦",
                cancelButtonText: "æ˜¯",
                reverseButtons: true,
                customClass: {
                    confirmButton: "swal-custom-cancel",
                    cancelButton: "swal-custom-button"
                }
            }).then((result) => {
                if (!result.isConfirmed) {
                    showRejectReasonModal();
                }
            });
        }
        
        function showRejectReasonModal() {
            Swal.fire({
                title: "æ‹’çµ•åŸå› ",
                icon: "question",
                showCancelButton: false,
                showConfirmButton: false,
                html: `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <button class="swal2-confirm reason-button" data-reason="èœå–®">èœå–®</button>
                        <button class="swal2-confirm reason-button" data-reason="æ™‚é–“">æ™‚é–“</button>
                        <button class="swal2-confirm reason-button" data-reason="åœ°å€">åœ°å€</button>
                        <button class="swal2-confirm reason-button" data-reason="å…¶ä»–">å…¶ä»–</button>
                    </div>
                `,
                didOpen: () => {
                    document.querySelectorAll(".reason-button").forEach(button => {
                        button.addEventListener("click", function () {
                            let reason = this.getAttribute("data-reason");
                            
                            // ç™¼é€æ‹’çµ•è«‹æ±‚
                            fetch(`/chef/order/{{ order.id }}/reject`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ reason: reason })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire({
                                        title: `è¨‚å–®å·²æ‹’çµ•`,
                                        text: `åŸå› ï¼š${reason}`,
                                        icon: "success",
                                        confirmButtonText: "ç¢ºèª"
                                    }).then(() => {
                                        window.location.href = "{{ url_for('chef_pending_orders') }}";
                                    });
                                } else {
                                    Swal.fire({
                                        title: "æ‹’çµ•å¤±æ•—",
                                        text: data.message,
                                        icon: "error"
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire({
                                    title: "æ‹’çµ•å¤±æ•—",
                                    text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                                    icon: "error"
                                });
                            });
                        });
                    });
                }
            });
        }
        
        // æå‡ºè­°åƒ¹
        document.getElementById('negotiation-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = document.getElementById('proposed-amount').value;
            const message = document.getElementById('negotiation-message').value;
            
            if (!amount || amount <= 0) {
                Swal.fire({
                    title: "è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡",
                    icon: "warning"
                });
                return;
            }
            
            fetch(`/chef/order/{{ order.id }}/negotiate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    proposed_amount: parseFloat(amount),
                    message: message || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "è­°åƒ¹ææ¡ˆå·²é€å‡º",
                        text: "ç­‰å¾…é¡§å®¢å›æ‡‰",
                        icon: "success"
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: "è­°åƒ¹å¤±æ•—",
                        text: data.message,
                        icon: "error"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "è­°åƒ¹å¤±æ•—",
                    text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                    icon: "error"
                });
            });
        });
        
        // ç¢ºèªè­°åƒ¹
        function confirmNegotiation() {
            Swal.fire({
                title: "ç¢ºå®šé–‹å§‹è£½ä½œï¼Ÿ",
                text: "ç¢ºèªå¾Œå°‡é–‹å§‹æº–å‚™é¤é»",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "é–‹å§‹è£½ä½œ",
                cancelButtonText: "å–æ¶ˆ"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/confirm_negotiation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "é–‹å§‹è£½ä½œ",
                                text: "è¨‚å–®å·²é€²å…¥è£½ä½œéšæ®µ",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "æ“ä½œå¤±æ•—",
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: "æ“ä½œå¤±æ•—",
                            text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                            icon: "error"
                        });
                    });
                }
            });
        }

        // å›æ‡‰é¡§å®¢å†è­°åƒ¹
        function respondToCounterOffer(negotiationId, isAccepted) {
            const actionText = isAccepted ? "æ¥å—" : "æ‹’çµ•";
            const warningText = isAccepted ? "ç¢ºå®šæ¥å—é¡§å®¢çš„è­°åƒ¹ï¼Ÿ" : "ç¢ºå®šæ‹’çµ•é¡§å®¢è­°åƒ¹ï¼Ÿè¨‚å–®å°‡è¢«å–æ¶ˆã€‚";
            
            Swal.fire({
                title: `${actionText}é¡§å®¢è­°åƒ¹`,
                text: warningText,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: `ç¢ºå®š${actionText}`,
                cancelButtonText: "å–æ¶ˆ",
                confirmButtonColor: isAccepted ? "#28a745" : "#dc3545"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/respond_counter_offer/${negotiationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            is_accepted: isAccepted
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: `${actionText}æˆåŠŸ`,
                                text: data.message,
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: `${actionText}å¤±æ•—`,
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: `${actionText}å¤±æ•—`,
                            text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                            icon: "error"
                        });
                    });
                }
            });
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œæ·»åŠ äº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // è™•ç†æ¥å—å†è­°åƒ¹æŒ‰éˆ•
            const acceptButtons = document.querySelectorAll('.accept-counter-offer');
            acceptButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const negotiationId = this.getAttribute('data-negotiation-id');
                    respondToCounterOffer(negotiationId, true);
                });
            });

            // è™•ç†æ‹’çµ•å†è­°åƒ¹æŒ‰éˆ•
            const rejectButtons = document.querySelectorAll('.reject-counter-offer');
            rejectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const negotiationId = this.getAttribute('data-negotiation-id');
                    respondToCounterOffer(negotiationId, false);
                });
            });
        });

        // é¤é»è£½ä½œå®Œæˆ
        function markOrderReady() {
            Swal.fire({
                title: "ç¢ºèªé¤é»è£½ä½œå®Œæˆ?",
                text: "æ‚¨ç¢ºå®šè¨‚å–® #{{ order.order_number }} çš„æ‰€æœ‰é¤é»éƒ½å·²è£½ä½œå®Œæˆå—ï¼Ÿ",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "æ˜¯çš„ï¼Œå·²å®Œæˆè£½ä½œ",
                cancelButtonText: "å–æ¶ˆ",
                confirmButtonColor: "#28a745"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/mark_ready`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "è£½ä½œå®Œæˆï¼",
                                text: "é¤é»å·²æ¨™è¨˜ç‚ºè£½ä½œå®Œæˆï¼Œé¡§å®¢å°‡æ”¶åˆ°é€šçŸ¥",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "æ“ä½œå¤±æ•—",
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: "æ“ä½œå¤±æ•—",
                            text: "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
                            icon: "error"
                        });
                    });
                }
            });
        }
    </script>

    <!-- é€šçŸ¥ä¸­å¿ƒçµ„ä»¶ -->
    {% include 'notification_component.html' %}
    
    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å¸³æˆ¶è¨­å®š</h3>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- å¸³è™Ÿè³‡è¨Šå€å¡Š -->
                <div class="account-section">
                    <div class="account-info-modern">
                        <img src="{{ current_user.avatar_url or '/static/imgs/avatar.png' }}" alt="Avatar" class="account-avatar">
                        <div class="account-details">
                            <div class="account-name">{{ current_user.name }}</div>
                            <div class="account-email">{{ current_user.email }}</div>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showProfileEditor()">
                        <div class="setting-icon">ğŸ‘¤</div>
                        <div class="setting-text">
                            <div class="setting-title">ç·¨è¼¯å€‹äººè³‡æ–™</div>
                            <div class="setting-desc">ä¿®æ”¹å§“åã€é ­åƒæˆ–å¯†ç¢¼</div>
                        </div>
                        <div class="setting-arrow">â†’</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="setting-item" onclick="window.location.href='/auth/logout'">
                    <div class="setting-icon">ğŸšª</div>
                    <div class="setting-text">
                        <div class="setting-title">ç™»å‡º</div>
                        <div class="setting-desc">ç™»å‡ºç›®å‰å¸³æˆ¶</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å€‹äººè³‡æ–™ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    {% include 'profile_editor_modal.html' %}

    <!-- é€šçŸ¥ä¸­å¿ƒ JavaScript -->
    <script>
        // é€šçŸ¥ç³»çµ±è®Šæ•¸
        let notifications = [];
        let unreadCount = 0;

        // è¼‰å…¥é€šçŸ¥è³‡æ–™
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    console.error('è¼‰å…¥é€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¨™è¨˜å·²è®€éŒ¯èª¤:', error);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é€šçŸ¥
        async function clearAllNotifications() {
            try {
                const response = await fetch('/api/notifications/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    notifications = [];
                    unreadCount = 0;
                    updateNotifications();
                    updateNotificationStatus();
                } else {
                    console.error('æ¸…ç©ºé€šçŸ¥å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('æ¸…ç©ºé€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // å–å¾—æœªè®€é€šçŸ¥æ•¸é‡
        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                } else {
                    console.error('å–å¾—æœªè®€æ•¸é‡å¤±æ•—:', result.message);
                }
            } catch (error) {
                console.error('å–å¾—æœªè®€æ•¸é‡éŒ¯èª¤:', error);
            }
        }

        // åˆ‡æ›é€šçŸ¥ä¸­å¿ƒé¡¯ç¤ºç‹€æ…‹
        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) {
                console.error('é€šçŸ¥ä¸­å¿ƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (notificationCenter.style.display === 'none' || !notificationCenter.style.display) {
                await loadNotifications();
                updateNotifications();
                notificationCenter.style.display = 'block';
            } else {
                notificationCenter.style.display = 'none';
            }
        }

        // æ›´æ–°é€šçŸ¥é€£çµçš„ç‹€æ…‹ï¼ˆæœªè®€æç¤ºï¼‰
        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.style.position = 'relative';
                notificationLink.innerHTML = `é€šçŸ¥ä¸­å¿ƒ <span style="position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;">${unreadCount}</span>`;
            } else {
                notificationLink.innerHTML = 'é€šçŸ¥ä¸­å¿ƒ';
            }
        }

        // è™•ç†é€šçŸ¥é»æ“Šè·³è½‰
        function handleNotificationClick(notification) {
            let targetUrl = '';
            
            switch(notification.type) {
                case 'new_order':
                    // æ–°è¨‚å–® -> å¾…æ¥å–®é é¢
                    targetUrl = '/chef/pending-orders';
                    break;
                case 'order_completed':
                    // è¨‚å–®å®Œæˆ -> å·²å®Œæˆè¨‚å–®é é¢
                    targetUrl = '/chef/completed-orders';
                    break;
                case 'new_review':
                    // æ–°è©•åƒ¹ -> å»šå¸«å„€è¡¨æ¿ï¼ˆæŸ¥çœ‹è©•åƒ¹ï¼‰
                    targetUrl = '/chef/';
                    break;
                case 'negotiation_response':
                    // è­°åƒ¹å›æ‡‰ -> è­°åƒ¹ä¸­è¨‚å–®é é¢
                    targetUrl = '/chef/negotiating-orders';
                    break;
                case 'order_accepted':
                case 'order_rejected':
                case 'order_ready':
                    // è¨‚å–®ç‹€æ…‹æ›´æ–° -> å°æ‡‰çš„è¨‚å–®è©³æƒ…
                    if (notification.order_id) {
                        targetUrl = `/chef/order/${notification.order_id}`;
                    }
                    break;
                default:
                    // é è¨­è·³è½‰åˆ°å„€è¡¨æ¿
                    targetUrl = '/chef/';
                    break;
            }
            
            if (targetUrl) {
                // é—œé–‰é€šçŸ¥ä¸­å¿ƒ
                const notificationCenter = document.getElementById('notificationCenter');
                if (notificationCenter) {
                    notificationCenter.style.display = 'none';
                }
                // è·³è½‰é é¢
                window.location.href = targetUrl;
            }
        }

        // æ›´æ–°é€šçŸ¥åˆ—è¡¨é¡¯ç¤º
        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;

            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš«ç„¡é€šçŸ¥</div>';
                notificationList.appendChild(li);
                return;
            }

            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                if (!notification.is_read) {
                    li.classList.add('unread');
                }

                // é€šçŸ¥é¡å‹åœ–æ¨™
                const typeIcon = {
                    'new_order': 'ğŸ“‹',
                    'order_completed': 'âœ…',
                    'new_review': 'â­',
                    'negotiation_response': 'ğŸ’¬',
                    'order_accepted': 'âœ…',
                    'order_rejected': 'âŒ',
                    'order_ready': 'ğŸ½ï¸',
                    'review_reply': 'ğŸ’¬'
                };
                const icon = typeIcon[notification.type] || 'ğŸ“¢';

                // åˆ¤æ–·æ˜¯å¦ç‚ºè¨‚å–®é¡é€šçŸ¥ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        li.classList.remove('unread');
                        li.querySelector('.notification-content > div').style.fontWeight = 'normal';
                        updateNotificationStatus();
                    }
                    
                    // æ ¹æ“šé€šçŸ¥é¡å‹è·³è½‰åˆ°å°æ‡‰é é¢
                    handleNotificationClick(notification);
                });

                notificationList.appendChild(li);
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationCenter = document.getElementById('notificationCenter');
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
        });

        // å®šæœŸæ›´æ–°æœªè®€é€šçŸ¥æ•¸é‡
        setInterval(getUnreadCount, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    </script>
</body>

</html> 