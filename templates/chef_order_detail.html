<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
    <title>訂單確認 - 味你而煮</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/Order.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/notification.css') }}">
    
    <style>
        /* Navbar 樣式修正 */
        .navbar .site-name {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .navbar .site-logo {
            width: 35px !important;
            height: 35px !important;
            object-fit: contain !important;
        }
        
        .navbar .site-text {
            display: flex !important;
            flex-direction: column !important;
            gap: 0px !important;
        }
        
        .navbar .site-title {
            font-size: 20px !important;
            font-weight: bold !important;
            color: #B3811C !important;
            line-height: 1.2 !important;
        }
        
        .navbar .site-subtitle {
            font-size: 12px !important;
            font-weight: normal !important;
            color: #B3811C !important;
            opacity: 0.8 !important;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        /* 用戶頭像大小限制 */
        .navbar .user-info .avatar {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            margin-right: 10px !important;
        }
        
        .user-info .name {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #B3811C !important;
        }
        
        .user-info .email {
            font-size: 16px !important;
            color: #8B6014 !important;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">味你而煮</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            {% if current_user %}
                {% if current_user.role and current_user.role.value == 'chef' %}
                <!-- 廚師專用導航 -->
                <a href="{{ url_for('chef_dashboard') }}">總覽</a>
                <a href="{{ url_for('chef_pending_orders') }}">待接單訂單</a>
                
                <!-- 廚師的我的訂單下拉選單 -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">我的訂單 ▾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">待完成訂單</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">已完成訂單</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">議價中訂單</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">已取消訂單</a>
                    </div>
                </div>
                
                <a href="#">客服聯絡</a>
                {% else %}
                <!-- 顧客專用導航 -->
                <a href="/customer/cooking_method">料理方式建議</a>
                <a href="{{ url_for('order_step0') }}">新增訂單</a>
                <a href="{{ url_for('customer_order_list') }}">我的訂單</a>
                <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">關於我們</a>
            <a href="{{ url_for('index') }}">料理方式建議</a>
            <a href="{{ url_for('index') }}">常見問題</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if current_user %}
            <img
                src="{{ current_user.avatar_url or '/static/imgs/avatar.png' }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ current_user.name }}</div>
                <div class="email">{{ current_user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>
    
    <div class="container">
        <div class="back-button" onclick="goBack()">← 返回</div>
        <div class="title">訂單編號 #{{ order.order_number }}</div>
        <div class="content">
            <p><strong>預約日期與時間：{{ order.preferred_time.strftime('%Y/%m/%d %H:%M') if order.preferred_time else '未指定' }}</strong></p>
            <p><strong>取餐方式：{{ '外送' if order.delivery_method.value == 'delivery' else '自取' }}</strong></p>
            <p><strong>聯絡人資訊：{{ order.customer.email }}</strong></p>
            <p><strong>聯絡電話：{{ order.customer.phone if order.customer.phone else '未提供' }}</strong></p>
            
            {% if order.customer_notes %}
            <p><strong>客戶備註：</strong>{{ order.customer_notes }}</p>
            {% endif %}
            
            <hr>
            <p><strong>菜單列表：</strong></p>
            
            {% for dish in order.dishes %}
            <p><strong>{{ loop.index }}. {{ dish.dish_name }} {{ dish.quantity }}人份</strong></p>
            <p>（鹹度:{{ dish.salt_level.value | replace('light', '清淡') | replace('normal', '正常') | replace('heavy', '重鹹') }} 
               辣度:{{ dish.spice_level.value | replace('none', '不辣') | replace('mild', '微辣') | replace('medium', '中辣') | replace('spicy', '辣') | replace('very_spicy', '超辣') }} 
               ）</p>
            
            {% if dish.ingredients %}
            <p>食材：{{ dish.ingredients }}</p>
            {% endif %}
            
            {% if dish.custom_notes %}
            <p>客製化補充：{{ dish.custom_notes }}</p>
            {% endif %}
            
            {% if dish.special_instructions %}
            <p>做法：{{ dish.special_instructions }}</p>
            {% endif %}
            
            {% if not loop.last %}<br>{% endif %}
            {% endfor %}

        </div>
        
        {% if order.status.value == 'pending' %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold;">請確認是否要接單？</p>
        <div class="buttons">
            <button class="reject" onclick="rejectOrder()">拒絕</button>
            <button class="accept" type="button" onclick="acceptOrder()">接單</button>
        </div>
        
        {% elif order.status.value == 'negotiating' %}
        <!-- 檢查是否有最終定價等待顧客回應 -->
        {% if chef_final_pricing_pending %}
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4 style="color: #856404;">⏳ 等待顧客回應最終定價</h4>
            <p style="color: #856404;">您已提交最終定價，請耐心等待顧客回應。在此期間無法修改訂單。</p>
            {% for nego in order.negotiations %}
                {% if nego.proposed_by == 'chef' and nego.is_accepted is none %}
                <p style="color: #856404;"><strong>最終定價：NT${{ nego.proposed_amount | int }}</strong></p>
                {% if nego.message %}
                <p style="color: #856404;">說明：{{ nego.message }}</p>
                {% endif %}
                {% endif %}
            {% endfor %}
        </div>
        
        {% else %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold; color: #FF8C00;">
            訂單進入議價階段（{{ order.negotiation_count }}/2 次議價）
        </p>
        
        <!-- 顯示議價歷史 -->
        {% if order.negotiations %}
        <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
            <h4>議價記錄：</h4>
            {% for nego in order.negotiations %}
            <div style="border-left: 3px solid #007bff; padding: 10px; margin: 10px 0; background: white;">
                <p><strong>{{ '廚師' if nego.proposed_by == 'chef' else '顧客' }}提議：</strong> NT${{ nego.proposed_amount | int }}</p>
                {% if nego.message %}<p><strong>說明：</strong>{{ nego.message }}</p>{% endif %}
                <p><strong>時間：</strong>{{ nego.created_at.strftime('%m/%d %H:%M') }}</p>
                {% if nego.is_accepted is not none %}
                <p><strong>狀態：</strong>
                    {% if nego.is_accepted %}
                    <span style="color: green;">已接受</span>
                    {% else %}
                    <span style="color: red;">已拒絕</span>
                    {% endif %}
                </p>
                {% if nego.response_message %}<p><strong>回應：</strong>{{ nego.response_message }}</p>{% endif %}
                {% else %}
                <p><strong>狀態：</strong><span style="color: orange;">等待回應</span></p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- 議價操作 -->
        {% if order.negotiation_count < 2 %}
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4>提出議價：</h4>
            <form id="negotiation-form" style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                    <label>建議金額：</label>
                    <input type="number" id="proposed-amount" step="0.01" min="0" placeholder="請輸入建議金額" required style="width: 200px; padding: 5px;">
                </div>
                <div>
                    <label>議價說明：</label>
                    <textarea id="negotiation-message" placeholder="說明議價原因（選填）" style="width: 100%; padding: 5px; height: 60px;"></textarea>
                </div>
                <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    提出議價
                </button>
            </form>
        </div>
        {% else %}
        <p style="text-align: center; margin-top: 15px; color: #dc3545;">
            已達最大議價次數，等待顧客回應
        </p>
        {% endif %}
        
        <!-- 檢查是否有被接受的議價 -->
        {% set accepted_nego = None %}
        {% set customer_counter_offer = None %}
        {% for nego in order.negotiations %}
            {% if nego.is_accepted %}
                {% set accepted_nego = nego %}
            {% elif nego.proposed_by == 'customer' and (nego.is_accepted is none or nego.is_accepted is null or nego.is_accepted == None) %}
                {% set customer_counter_offer = nego %}
            {% endif %}
        {% endfor %}
        
        {% if customer_counter_offer %}
        <!-- 顯示顧客的再議價 -->
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
            <h4 style="color: #856404;">顧客再議價：NT${{ customer_counter_offer.proposed_amount | int }}</h4>
            {% if customer_counter_offer.message %}
            <p style="color: #856404; margin: 10px 0;">顧客說明：{{ customer_counter_offer.message }}</p>
            {% endif %}
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <a href="{{ url_for('chef_counter_offer_response', order_id=order.id) }}" 
                   style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; text-decoration: none; display: inline-block;">
                    前往議價回應頁面
                </a>
                <button class="accept-counter-offer" data-negotiation-id="{{ customer_counter_offer.id }}" 
                        style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    快速接受議價
                </button>
                <button class="reject-counter-offer" data-negotiation-id="{{ customer_counter_offer.id }}" 
                        style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    拒絕議價（取消訂單）
                </button>
            </div>
        </div>
        {% elif accepted_nego %}
        <div style="background: #d4edda; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #c3e6cb;">
            <p style="color: #155724; font-weight: bold;">顧客已接受議價：NT${{ accepted_nego.proposed_amount | int }}</p>
            <button onclick="confirmNegotiation()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                確認開始製作
            </button>
        </div>
        {% endif %}
        {% endif %}
        
        {% else %}
        <p style="text-align: center; margin-top: 15px; font-weight: bold; color: #666;">
            此訂單狀態：{{ order.status.value | replace('accepted', '已接單') | replace('preparing', '製作中') | replace('ready', '製作完成') | replace('completed', '已完成') | replace('cancelled', '已取消') | replace('negotiating', '議價中') | replace('pending', '等待回應') }}
        </p>
        
        {% if order.status.value == 'accepted' %}
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="markOrderReady()" style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                餐點製作完成
            </button>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <!-- 添加資料屬性 -->
    {% set has_customer_counter = false %}
    {% for nego in order.negotiations %}
        {% if nego.proposed_by == 'customer' and (nego.is_accepted is none or nego.is_accepted is null or nego.is_accepted == None) %}
            {% set has_customer_counter = true %}
        {% endif %}
    {% endfor %}
    
    <!-- 調試：顯示每個議價記錄的詳細信息 -->
    <div id="debug-info" style="display: none;">
        {% for nego in order.negotiations %}
        <div data-nego-id="{{ nego.id }}" 
             data-proposed-by="{{ nego.proposed_by }}" 
             data-is-accepted="{{ nego.is_accepted if nego.is_accepted is not none else 'null' }}"
             data-amount="{{ nego.proposed_amount }}"></div>
        {% endfor %}
    </div>
    
    <div id="page-data" 
         data-has-counter-offer="{{ 'true' if has_customer_counter else 'false' }}"
         data-counter-offer-url="{{ url_for('chef_counter_offer_response', order_id=order.id) }}"
         data-order-id="{{ order.id }}"
         style="display: none;"></div>

    <script>
        // 調試信息：檢查所有議價記錄
        const debugInfo = document.getElementById('debug-info');
        const negoElements = debugInfo.querySelectorAll('[data-nego-id]');
        console.log('=== 議價記錄調試 ===');
        negoElements.forEach(elem => {
            console.log('議價記錄:', {
                id: elem.getAttribute('data-nego-id'),
                proposed_by: elem.getAttribute('data-proposed-by'),
                is_accepted: elem.getAttribute('data-is-accepted'),
                amount: elem.getAttribute('data-amount')
            });
        });
        
        // 檢查是否有待回應的顧客議價
        const pageData = document.getElementById('page-data');
        const hasCounterOffer = pageData.getAttribute('data-has-counter-offer') === 'true';
        const orderStatus = '{{ order.status.value }}';
        
        console.log('自動跳轉檢查 - 有顧客議價:', hasCounterOffer, '訂單狀態:', orderStatus);
        
        // 手動檢查是否有未回應的顧客議價
        let manualCheck = false;
        negoElements.forEach(elem => {
            const proposedBy = elem.getAttribute('data-proposed-by');
            const isAccepted = elem.getAttribute('data-is-accepted');
            if (proposedBy === 'customer' && (isAccepted === 'null' || isAccepted === 'None' || isAccepted === '')) {
                manualCheck = true;
                console.log('手動檢查發現未回應的顧客議價:', elem.getAttribute('data-nego-id'));
            }
        });
        
        console.log('手動檢查結果:', manualCheck);
        
        if ((hasCounterOffer || manualCheck) && orderStatus === 'negotiating') {
            const counterOfferUrl = pageData.getAttribute('data-counter-offer-url');
            console.log('準備跳轉到:', counterOfferUrl);
            
            // 直接跳轉到議價回應頁面（移除提示）
            window.location.href = counterOfferUrl;
        }
        
        // 切換設定視窗
        function toggleSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        // 下拉選單切換功能
        function toggleDropdown() {
            var dropdown = document.getElementById("orderDropdown");
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
            } else {
                dropdown.style.display = "block";
            }
        }

        // 點擊其他地方關閉下拉選單和設定視窗
        window.addEventListener('click', function(event) {
            // 關閉下拉選單
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.style.display === "block") {
                        openDropdown.style.display = "none";
                    }
                }
            }
            
            // 關閉設定視窗
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
        });

        function goBack() {
            window.history.back();
        }
        
        function acceptOrder() {
            // 發送接單請求
            fetch(`/chef/order/{{ order.id }}/accept`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "接單成功！",
                        text: "請進行價格估算",
                        icon: "success",
                        confirmButtonText: "立即前往估價",
                        showCancelButton: true,
                        cancelButtonText: "稍後處理",
                        customClass: {
                            confirmButton: "swal-custom-button",
                            cancelButton: "swal-custom-cancel"
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // 跳轉到估價頁面
                            window.location.href = data.redirect_url || `/chef/order/{{ order.id }}/pricing`;
                        } else {
                            // 跳轉到待接單頁面
                            window.location.href = "{{ url_for('chef_pending_orders') }}";
                        }
                    });
                } else {
                    Swal.fire({
                        title: "接單失敗",
                        text: data.message,
                        icon: "error"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "接單失敗",
                    text: "系統錯誤，請稍後再試",
                    icon: "error"
                });
            });
        }
        
        function rejectOrder() {
            Swal.fire({
                title: "確定拒絕此單",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "否",
                cancelButtonText: "是",
                reverseButtons: true,
                customClass: {
                    confirmButton: "swal-custom-cancel",
                    cancelButton: "swal-custom-button"
                }
            }).then((result) => {
                if (!result.isConfirmed) {
                    showRejectReasonModal();
                }
            });
        }
        
        function showRejectReasonModal() {
            Swal.fire({
                title: "拒絕原因",
                icon: "question",
                showCancelButton: false,
                showConfirmButton: false,
                html: `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <button class="swal2-confirm reason-button" data-reason="菜單">菜單</button>
                        <button class="swal2-confirm reason-button" data-reason="時間">時間</button>
                        <button class="swal2-confirm reason-button" data-reason="地區">地區</button>
                        <button class="swal2-confirm reason-button" data-reason="其他">其他</button>
                    </div>
                `,
                didOpen: () => {
                    document.querySelectorAll(".reason-button").forEach(button => {
                        button.addEventListener("click", function () {
                            let reason = this.getAttribute("data-reason");
                            
                            // 發送拒絕請求
                            fetch(`/chef/order/{{ order.id }}/reject`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ reason: reason })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire({
                                        title: `訂單已拒絕`,
                                        text: `原因：${reason}`,
                                        icon: "success",
                                        confirmButtonText: "確認"
                                    }).then(() => {
                                        window.location.href = "{{ url_for('chef_pending_orders') }}";
                                    });
                                } else {
                                    Swal.fire({
                                        title: "拒絕失敗",
                                        text: data.message,
                                        icon: "error"
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire({
                                    title: "拒絕失敗",
                                    text: "系統錯誤，請稍後再試",
                                    icon: "error"
                                });
                            });
                        });
                    });
                }
            });
        }
        
        // 提出議價
        document.getElementById('negotiation-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = document.getElementById('proposed-amount').value;
            const message = document.getElementById('negotiation-message').value;
            
            if (!amount || amount <= 0) {
                Swal.fire({
                    title: "請輸入有效金額",
                    icon: "warning"
                });
                return;
            }
            
            fetch(`/chef/order/{{ order.id }}/negotiate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    proposed_amount: parseFloat(amount),
                    message: message || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "議價提案已送出",
                        text: "等待顧客回應",
                        icon: "success"
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: "議價失敗",
                        text: data.message,
                        icon: "error"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "議價失敗",
                    text: "系統錯誤，請稍後再試",
                    icon: "error"
                });
            });
        });
        
        // 確認議價
        function confirmNegotiation() {
            Swal.fire({
                title: "確定開始製作？",
                text: "確認後將開始準備餐點",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "開始製作",
                cancelButtonText: "取消"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/confirm_negotiation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "開始製作",
                                text: "訂單已進入製作階段",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "操作失敗",
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: "操作失敗",
                            text: "系統錯誤，請稍後再試",
                            icon: "error"
                        });
                    });
                }
            });
        }

        // 回應顧客再議價
        function respondToCounterOffer(negotiationId, isAccepted) {
            const actionText = isAccepted ? "接受" : "拒絕";
            const warningText = isAccepted ? "確定接受顧客的議價？" : "確定拒絕顧客議價？訂單將被取消。";
            
            Swal.fire({
                title: `${actionText}顧客議價`,
                text: warningText,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: `確定${actionText}`,
                cancelButtonText: "取消",
                confirmButtonColor: isAccepted ? "#28a745" : "#dc3545"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/respond_counter_offer/${negotiationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            is_accepted: isAccepted
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: `${actionText}成功`,
                                text: data.message,
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: `${actionText}失敗`,
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: `${actionText}失敗`,
                            text: "系統錯誤，請稍後再試",
                            icon: "error"
                        });
                    });
                }
            });
        }

        // 頁面加載完成後添加事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            // 處理接受再議價按鈕
            const acceptButtons = document.querySelectorAll('.accept-counter-offer');
            acceptButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const negotiationId = this.getAttribute('data-negotiation-id');
                    respondToCounterOffer(negotiationId, true);
                });
            });

            // 處理拒絕再議價按鈕
            const rejectButtons = document.querySelectorAll('.reject-counter-offer');
            rejectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const negotiationId = this.getAttribute('data-negotiation-id');
                    respondToCounterOffer(negotiationId, false);
                });
            });
        });

        // 餐點製作完成
        function markOrderReady() {
            Swal.fire({
                title: "確認餐點製作完成?",
                text: "您確定訂單 #{{ order.order_number }} 的所有餐點都已製作完成嗎？",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "是的，已完成製作",
                cancelButtonText: "取消",
                confirmButtonColor: "#28a745"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/chef/order/{{ order.id }}/mark_ready`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "製作完成！",
                                text: "餐點已標記為製作完成，顧客將收到通知",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "操作失敗",
                                text: data.message,
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: "操作失敗",
                            text: "系統錯誤，請稍後再試",
                            icon: "error"
                        });
                    });
                }
            });
        }
    </script>

    <!-- 通知中心組件 -->
    {% include 'notification_component.html' %}
    
    <!-- 設定模態框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>帳戶設定</h3>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 帳號資訊區塊 -->
                <div class="account-section">
                    <div class="account-info-modern">
                        <img src="{{ current_user.avatar_url or '/static/imgs/avatar.png' }}" alt="Avatar" class="account-avatar">
                        <div class="account-details">
                            <div class="account-name">{{ current_user.name }}</div>
                            <div class="account-email">{{ current_user.email }}</div>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showProfileEditor()">
                        <div class="setting-icon">👤</div>
                        <div class="setting-text">
                            <div class="setting-title">編輯個人資料</div>
                            <div class="setting-desc">修改姓名、頭像或密碼</div>
                        </div>
                        <div class="setting-arrow">→</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="setting-item" onclick="window.location.href='/auth/logout'">
                    <div class="setting-icon">🚪</div>
                    <div class="setting-text">
                        <div class="setting-title">登出</div>
                        <div class="setting-desc">登出目前帳戶</div>
                    </div>
                    <div class="setting-arrow">→</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 個人資料編輯模態框 -->
    {% include 'profile_editor_modal.html' %}

    <!-- 通知中心 JavaScript -->
    <script>
        // 通知系統變數
        let notifications = [];
        let unreadCount = 0;

        // 載入通知資料
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    console.error('載入通知失敗:', result.message);
                }
            } catch (error) {
                console.error('載入通知錯誤:', error);
            }
        }

        // 標記通知為已讀
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('標記已讀失敗:', result.message);
                }
            } catch (error) {
                console.error('標記已讀錯誤:', error);
            }
        }

        // 清空所有通知
        async function clearAllNotifications() {
            try {
                const response = await fetch('/api/notifications/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    notifications = [];
                    unreadCount = 0;
                    updateNotifications();
                    updateNotificationStatus();
                } else {
                    console.error('清空通知失敗:', result.message);
                }
            } catch (error) {
                console.error('清空通知錯誤:', error);
            }
        }

        // 取得未讀通知數量
        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                } else {
                    console.error('取得未讀數量失敗:', result.message);
                }
            } catch (error) {
                console.error('取得未讀數量錯誤:', error);
            }
        }

        // 切換通知中心顯示狀態
        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) {
                console.error('通知中心元素未找到');
                return;
            }
            
            if (notificationCenter.style.display === 'none' || !notificationCenter.style.display) {
                await loadNotifications();
                updateNotifications();
                notificationCenter.style.display = 'block';
            } else {
                notificationCenter.style.display = 'none';
            }
        }

        // 更新通知連結的狀態（未讀提示）
        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.style.position = 'relative';
                notificationLink.innerHTML = `通知中心 <span style="position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;">${unreadCount}</span>`;
            } else {
                notificationLink.innerHTML = '通知中心';
            }
        }

        // 處理通知點擊跳轉
        function handleNotificationClick(notification) {
            let targetUrl = '';
            
            switch(notification.type) {
                case 'new_order':
                    // 新訂單 -> 待接單頁面
                    targetUrl = '/chef/pending-orders';
                    break;
                case 'order_completed':
                    // 訂單完成 -> 已完成訂單頁面
                    targetUrl = '/chef/completed-orders';
                    break;
                case 'new_review':
                    // 新評價 -> 廚師儀表板（查看評價）
                    targetUrl = '/chef/';
                    break;
                case 'negotiation_response':
                    // 議價回應 -> 議價中訂單頁面
                    targetUrl = '/chef/negotiating-orders';
                    break;
                case 'order_accepted':
                case 'order_rejected':
                case 'order_ready':
                    // 訂單狀態更新 -> 對應的訂單詳情
                    if (notification.order_id) {
                        targetUrl = `/chef/order/${notification.order_id}`;
                    }
                    break;
                default:
                    // 預設跳轉到儀表板
                    targetUrl = '/chef/';
                    break;
            }
            
            if (targetUrl) {
                // 關閉通知中心
                const notificationCenter = document.getElementById('notificationCenter');
                if (notificationCenter) {
                    notificationCenter.style.display = 'none';
                }
                // 跳轉頁面
                window.location.href = targetUrl;
            }
        }

        // 更新通知列表顯示
        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;

            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暫無通知</div>';
                notificationList.appendChild(li);
                return;
            }

            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                if (!notification.is_read) {
                    li.classList.add('unread');
                }

                // 通知類型圖標
                const typeIcon = {
                    'new_order': '📋',
                    'order_completed': '✅',
                    'new_review': '⭐',
                    'negotiation_response': '💬',
                    'order_accepted': '✅',
                    'order_rejected': '❌',
                    'order_ready': '🍽️',
                    'review_reply': '💬'
                };
                const icon = typeIcon[notification.type] || '📢';

                // 判斷是否為訂單類通知，如果是則顯示訂單編號
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        li.classList.remove('unread');
                        li.querySelector('.notification-content > div').style.fontWeight = 'normal';
                        updateNotificationStatus();
                    }
                    
                    // 根據通知類型跳轉到對應頁面
                    handleNotificationClick(notification);
                });

                notificationList.appendChild(li);
            });
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationCenter = document.getElementById('notificationCenter');
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
        });

        // 定期更新未讀通知數量
        setInterval(getUnreadCount, 30000); // 每30秒更新一次
    </script>
</body>

</html> 