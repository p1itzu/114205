<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <title>æœ€çµ‚å®šåƒ¹ç¢ºèª - å‘³ä½ è€Œç…®</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/Order.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
    
    <style>
        /* Navbar æ¨£å¼ä¿®æ­£ */
        .navbar .site-name {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }
        
        .navbar .site-logo {
            width: 35px !important;
            height: 35px !important;
            object-fit: contain !important;
        }
        
        .navbar .site-text {
            display: flex !important;
            flex-direction: column !important;
            gap: 0px !important;
        }
        
        .navbar .site-title {
            font-size: 20px !important;
            font-weight: bold !important;
            color: #B3811C !important;
            line-height: 1.2 !important;
        }
        
        .navbar .site-subtitle {
            font-size: 12px !important;
            font-weight: normal !important;
            color: #B3811C !important;
            opacity: 0.8 !important;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        .user-info .name {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #B3811C !important;
        }
        
        .user-info .email {
            font-size: 16px !important;
            color: #8B6014 !important;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">å‘³ä½ è€Œç…®</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">é¦–é </a>
            {% if user %}
                {% if user.role and user.role.value == 'chef' %}
                <!-- å»šå¸«å°ˆç”¨å°èˆª -->
                <a href="{{ url_for('chef_dashboard') }}">ç¸½è¦½</a>
                <a href="{{ url_for('chef_pending_orders') }}">å¾…æ¥å–®è¨‚å–®</a>
                
                <!-- å»šå¸«çš„æˆ‘çš„è¨‚å–®ä¸‹æ‹‰é¸å–® -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">æˆ‘çš„è¨‚å–® â–¾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å¾…å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å®Œæˆè¨‚å–®</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">è­°åƒ¹ä¸­è¨‚å–®</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">å·²å–æ¶ˆè¨‚å–®</a>
                    </div>
                </div>
                
                <a href="#">å®¢æœè¯çµ¡</a>
                {% else %}
                <!-- é¡§å®¢å°ˆç”¨å°èˆª -->
                <a href="/customer/cooking_method">æ–™ç†æ–¹å¼å»ºè­°</a>
                <a href="{{ url_for('order_step0') }}">æ–°å¢è¨‚å–®</a>
                <a href="{{ url_for('customer_order_list') }}">æˆ‘çš„è¨‚å–®</a>
                <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">é—œæ–¼æˆ‘å€‘</a>
            <a href="{{ url_for('index') }}">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('index') }}">å¸¸è¦‹å•é¡Œ</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ user.avatar_url or '/static/imgs/avatar.png' }}"
                alt="é ­åƒ"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">ç™»å…¥/è¨»å†Š</a>
            {% endif %}
        </div>
    </div>
    
    <div class="container">
        <div class="back-button" onclick="goBack()">â† è¿”å›</div>
        <div class="title">æœ€çµ‚å®šåƒ¹ç¢ºèª</div>
        <div class="subtitle">è¨‚å–®ç·¨è™Ÿ #{{ order.order_number }}</div>
        
        <div class="content">
            <!-- è¨‚å–®åŸºæœ¬ä¿¡æ¯ -->
            <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
                <h4>è¨‚å–®è³‡è¨Š</h4>
                <p><strong>é ç´„æ™‚é–“ï¼š</strong>{{ order.preferred_time.strftime('%Y/%m/%d %H:%M') if order.preferred_time else 'æœªæŒ‡å®š' }}</p>
                <p><strong>å–é¤æ–¹å¼ï¼š</strong>{{ 'å¤–é€' if order.delivery_method.value == 'delivery' else 'è‡ªå–' }}</p>
                {% if order.delivery_address %}
                <p><strong>åœ°å€ï¼š</strong>{{ order.delivery_address }}</p>
                {% endif %}
            </div>
            
            <!-- èœå“åˆ—è¡¨ -->
            <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
                <h4>èœå“æ˜ç´°</h4>
                {% for dish in order.dishes %}
                <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ dish.dish_name }} Ã— {{ dish.quantity }}</strong>
                            <div style="color: #666; font-size: 0.9em;">
                                é¹¹åº¦: {{ dish.salt_level.value | replace('light', 'æ¸…æ·¡') | replace('normal', 'æ­£å¸¸') | replace('heavy', 'é‡é¹¹') }}
                                | è¾£åº¦: {{ dish.spice_level.value | replace('none', 'ä¸è¾£') | replace('mild', 'å¾®è¾£') | replace('medium', 'ä¸­è¾£') | replace('spicy', 'è¾£') | replace('very_spicy', 'è¶…è¾£') }}
                            </div>
                            {% if dish.custom_notes %}
                            <div style="color: #666; font-size: 0.9em;">å‚™è¨»ï¼š{{ dish.custom_notes }}</div>
                            {% endif %}
                        </div>
                        <div style="font-weight: bold; color: #e74c3c;">
                            NT${{ dish.unit_price | int if dish.unit_price else 0 }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- å®šåƒ¹å°æ¯” -->
            <div style="background: #fff3cd; padding: 20px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffeaa7;">
                <h4 style="color: #856404; margin-bottom: 15px;">å®šåƒ¹èªªæ˜</h4>
                
                <!-- æ‰¾åˆ°æœ€æ–°çš„é¡§å®¢è­°åƒ¹è¨˜éŒ„ -->
                {% set customer_negotiation = none %}
                {% for nego in order.negotiations %}
                    {% if nego.proposed_by == 'customer' %}
                        {% set customer_negotiation = nego %}
                    {% endif %}
                {% endfor %}
                
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>æ‚¨çš„è­°åƒ¹é‡‘é¡ï¼š</span>
                    <span style="font-weight: bold;">
                        {% if customer_negotiation %}
                            NT${{ customer_negotiation.proposed_amount | int }}
                        {% else %}
                            æœªè­°åƒ¹
                        {% endif %}
                    </span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin: 10px 0; padding-top: 10px; border-top: 1px solid #ddd;">
                    <span style="font-size: 1.1em; font-weight: bold; color: #e74c3c;">å»šå¸«æœ€çµ‚å®šåƒ¹ï¼š</span>
                    <span style="font-size: 1.2em; font-weight: bold; color: #e74c3c;">NT${{ chef_final_pricing.proposed_amount | int }}</span>
                </div>
                
                {% if chef_final_pricing.message %}
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <strong>å»šå¸«èªªæ˜ï¼š</strong>
                    <p style="margin: 5px 0; color: #666;">{{ chef_final_pricing.message }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- æ±ºå®šæŒ‰éˆ• -->
            <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 5px; border: 1px solid #ddd;">
                <h4 style="text-align: center; margin-bottom: 20px; color: #333;">è«‹é¸æ“‡æ‚¨çš„æ±ºå®š</h4>
                
                {% if is_first_pricing %}
                <!-- ç¬¬ä¸€æ¬¡å ±åƒ¹ï¼šé¡¯ç¤º"åŒæ„"å’Œ"å†è­°åƒ¹" -->
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button onclick="respondToPricing(true)" 
                            style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; min-width: 150px;">
                        âœ“ åŒæ„
                    </button>
                    
                    <button onclick="showCounterOfferForm()" 
                            style="background: #ffc107; color: #333; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; min-width: 150px;">
                        ğŸ’¬ å†è­°åƒ¹
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                    <p>* æ‚¨å¯ä»¥åŒæ„æ­¤å ±åƒ¹æˆ–æå‡ºæ‚¨çš„è­°åƒ¹</p>
                </div>
                {% else %}
                <!-- å¤šæ¬¡è­°åƒ¹å¾Œï¼šé¡¯ç¤º"åŒæ„æœ€çµ‚å ±åƒ¹"å’Œ"ä¸åŒæ„å–æ¶ˆè¨‚å–®" -->
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button onclick="respondToPricing(true)" 
                            style="background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; min-width: 150px;">
                        âœ“ åŒæ„æœ€çµ‚å ±åƒ¹
                    </button>
                    
                    <button onclick="respondToPricing(false)" 
                            style="background: #dc3545; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; min-width: 150px;">
                        âœ— ä¸åŒæ„ä¸¦å–æ¶ˆè¨‚å–®
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                    <p>* é€™æ˜¯æœ€å¾Œçš„æ±ºå®šæ©Ÿæœƒ</p>
                    <p>* é¸æ“‡ã€Œä¸åŒæ„ã€å°‡æœƒå–æ¶ˆæ•´å€‹è¨‚å–®</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.location.href = "{{ url_for('customer_order_list') }}";
        }

        
        async function respondToPricing(isAccepted) {
            
            const actionText = isAccepted ? "æ¥å—" : "æ‹’çµ•";
            const warningText = isAccepted ? 
                "ç¢ºå®šæ¥å—å»šå¸«çš„æœ€çµ‚å®šåƒ¹å—ï¼Ÿè¨‚å–®å°‡é€²å…¥è£½ä½œéšæ®µã€‚" : 
                "ç¢ºå®šæ‹’çµ•æœ€çµ‚å®šåƒ¹å—ï¼Ÿè¨‚å–®å°‡æœƒè¢«å–æ¶ˆã€‚";
            
            const result = await Swal.fire({
                title: `${actionText}æœ€çµ‚å®šåƒ¹`,
                text: warningText,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: `ç¢ºå®š${actionText}`,
                cancelButtonText: "å–æ¶ˆ",
                confirmButtonColor: isAccepted ? "#28a745" : "#dc3545"
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/customer/order/{{ order.id }}/respond_final_pricing/{{ chef_final_pricing.id }}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            is_accepted: isAccepted
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        Swal.fire({
                            title: "æ“ä½œæˆåŠŸ",
                            text: data.message,
                            icon: "success",
                            confirmButtonText: "ç¢ºèª"
                        }).then(() => {
                            // æ ¹æ“šæ“ä½œçµæœæ±ºå®šè·³è½‰é é¢
                            if (isAccepted) {
                                window.location.href = "{{ url_for('customer_order_list') }}";
                            } else {
                                // æ‹’çµ•æœ€çµ‚å®šåƒ¹ï¼Œè·³è½‰åˆ°é‡æ–°é¸æ“‡å»šå¸«é é¢
                                window.location.href = `/customer/order/{{ order.id }}/reselect_chef`;
                            }
                        });
                    } else {
                        // å¦‚æœæ˜¯é‡å¤æäº¤çš„é”™è¯¯ï¼Œä¸æ˜¾ç¤ºalert
                        if (data.message && data.message.includes("æ­¤è­°åƒ¹å·²å›æ‡‰é")) {
                            // é™é»˜å¤„ç†ï¼Œç›´æ¥è·³è½¬
                            if (isAccepted) {
                                window.location.href = "{{ url_for('customer_order_list') }}";
                            } else {
                                window.location.href = `/customer/order/{{ order.id }}/reselect_chef`;
                            }
                        } else {
                            Swal.fire({
                                title: "æ“ä½œå¤±æ•—",
                                text: data.message || "è«‹ç¨å¾Œå†è©¦",
                                icon: "error",
                                confirmButtonText: "ç¢ºèª"
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        title: "ç¶²è·¯éŒ¯èª¤",
                        text: "è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡è©¦",
                        icon: "error",
                        confirmButtonText: "ç¢ºèª"
                    });
                }
            }
        }

        // é¡¯ç¤ºè­°åƒ¹è¡¨å–®
        async function showCounterOfferForm() {
            const { value: formValues } = await Swal.fire({
                title: 'æå‡ºæ‚¨çš„è­°åƒ¹',
                html: `
                    <div style="text-align: left;">
                        <p style="margin-bottom: 10px; color: #666;">
                            å»šå¸«å ±åƒ¹ï¼š<strong style="color: #333;">NT$ {{ chef_final_pricing.proposed_amount | round | int }}</strong>
                        </p>
                        <label for="counter-amount" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            æ‚¨çš„å‡ºåƒ¹ (NT$)ï¼š
                        </label>
                        <input id="counter-amount" type="number" class="swal2-input" placeholder="è«‹è¼¸å…¥é‡‘é¡" 
                               min="1" step="1" style="width: 90%; margin: 0 auto 15px;">
                        
                        <label for="counter-message" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            ç•™è¨€çµ¦å»šå¸«ï¼ˆé¸å¡«ï¼‰ï¼š
                        </label>
                        <textarea id="counter-message" class="swal2-textarea" placeholder="èªªæ˜æ‚¨çš„è­°åƒ¹ç†ç”±..."
                                  style="width: 90%; margin: 0 auto; height: 100px;"></textarea>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'æäº¤è­°åƒ¹',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#ffc107',
                preConfirm: () => {
                    const amount = document.getElementById('counter-amount').value;
                    const message = document.getElementById('counter-message').value;
                    
                    if (!amount || amount <= 0) {
                        Swal.showValidationMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                        return false;
                    }
                    
                    return {
                        amount: parseFloat(amount),
                        message: message
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch(`/customer/order/{{ order.id }}/counter_offer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            proposed_amount: formValues.amount,
                            message: formValues.message
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        Swal.fire({
                            title: 'è­°åƒ¹å·²æäº¤',
                            text: data.message,
                            icon: 'success',
                            confirmButtonText: 'ç¢ºèª'
                        }).then(() => {
                            window.location.href = "{{ url_for('customer_order_list') }}";
                        });
                    } else {
                        Swal.fire({
                            title: 'æäº¤å¤±æ•—',
                            text: data.message || 'è«‹ç¨å¾Œå†è©¦',
                            icon: 'error',
                            confirmButtonText: 'ç¢ºèª'
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'ç¶²è·¯éŒ¯èª¤',
                        text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡è©¦',
                        icon: 'error',
                        confirmButtonText: 'ç¢ºèª'
                    });
                }
            }
        }
    </script>
</body>
</html> 