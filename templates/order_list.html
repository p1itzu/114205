<!DOCTYPE html>

<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¨‚å–®</title>
    <link rel="stylesheet" href="/static/css/my-order.css" />
    <link rel="stylesheet" href="/static/css/notification.css" />
</head>
<body>
    <div class="navbar">
        <div class="site-name">å‘³ä½ è€Œç…®</div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">é¦–é </a>
            {% if user %}
            <a href="/customer/cooking_method">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('order_step0') }}">æ–°å¢è¨‚å–®</a>
            <a href="{{ url_for('customer_order_list') }}">æˆ‘çš„è¨‚å–®</a>
            <a href="#" onclick="toggleNotification(); return false;">é€šçŸ¥ä¸­å¿ƒ</a>
            {% else %}
            <a href="{{ url_for('index') }}">é—œæ–¼æˆ‘å€‘</a>
            <a href="{{ url_for('index') }}">æ–™ç†æ–¹å¼å»ºè­°</a>
            <a href="{{ url_for('index') }}">å¸¸è¦‹å•é¡Œ</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="é ­åƒ"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">ç™»å…¥/è¨»å†Š</a>
            {% endif %}
        </div>
    </div>

<br>
<div class="maintext">æ‰€æœ‰è¨‚å–®</div>
<div class="filter-buttons">
    <button class="filter-btn active" data-status="all">å…¨éƒ¨</button>
    <button class="filter-btn" data-status="ongoing">é€²è¡Œä¸­</button>
    <button class="filter-btn" data-status="completed">å·²å®Œæˆ</button>
    <button class="filter-btn" data-status="cancelled">å·²å–æ¶ˆ</button>
</div>
<div class="container">
    {% for order in orders %}
    <!-- æª¢æŸ¥æ˜¯å¦æœ‰å¾…å›æ‡‰çš„å»šå¸«æœ€çµ‚å®šåƒ¹ -->
    {% set chef_final_pricing = none %}
    {% for nego in order.negotiations %}
        {% if nego.proposed_by == 'chef' and nego.is_accepted is none %}
            {% set chef_final_pricing = nego %}
        {% endif %}
    {% endfor %}
    
    <div class="order-card" data-status="
        {%- if order.status.value in ['pending', 'negotiating', 'accepted', 'preparing', 'ready'] -%}ongoing
        {%- elif order.status.value == 'completed' -%}completed
        {%- elif order.status.value == 'cancelled' -%}cancelled
        {%- else -%}all
        {%- endif -%}">
        
        <!-- æœ€çµ‚å®šåƒ¹å¾…å›æ‡‰æé†’ -->
        {% if chef_final_pricing %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
            <div style="color: #856404; font-weight: bold; font-size: 14px;">
                ğŸ”” å»šå¸«å·²æä¾›æœ€çµ‚å®šåƒ¹ï¼Œè«‹å„˜å¿«å›æ‡‰ï¼
            </div>
            <div style="color: #856404; font-size: 12px; margin-top: 5px;">
                æœ€çµ‚å®šåƒ¹ï¼šNT${{ chef_final_pricing.proposed_amount | int }}
            </div>
        </div>
        {% endif %}
        
        <div class="order-header">
            <span class="order-num"><strong>è¨‚å–®ç·¨è™Ÿ #{{ order.id }}</strong></span>
            <span class="order-status">
                <!-- Debug: é¡¯ç¤ºåŸå§‹ç‹€æ…‹ä¿¡æ¯ -->
                <!-- ç‹€æ…‹å°è±¡: {{ order.status }}, ç‹€æ…‹å€¼: {{ order.status.value }} -->
                <span class="status {{ order.status.value }}" style="background-color: #FF9800; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                    {% if order.status.value == 'pending' %}ç­‰å¾…å›æ‡‰
                    {% elif order.status.value == 'negotiating' %}è­°åƒ¹ä¸­
                    {% elif order.status.value == 'accepted' %}å·²æ¥å–®
                    {% elif order.status.value == 'preparing' %}è£½ä½œä¸­
                    {% elif order.status.value == 'ready' %}è£½ä½œå®Œæˆ
                    {% elif order.status.value == 'completed' %}äº¤ä»˜å®Œæˆ
                    {% elif order.status.value == 'cancelled' %}å·²å–æ¶ˆ
                    {% elif order.status.value == 'reselecting_chef' %}é‡æ–°é¸æ“‡å»šå¸«
                    {% else %}{{ order.status.value }}
                    {% endif %}
                </span>
            </span>
        </div>
        <p>
            èœå–®åˆ—è¡¨ï¼š<br>
            {% for dish in order.dishes %}
                {{ loop.index }}. {{ dish.dish_name }}<br>
            {% endfor %}
        </p>
        <div class="button-group">
            {% if order.status.value == 'reselecting_chef' %}
            <a href="{{ url_for('reselect_chef', order_id=order.id) }}" 
               class="order-btn" 
               style="background: #ff6b35; color: white; text-decoration: none; font-weight: bold;">
                é‡æ–°é¸æ“‡å»šå¸«
            </a>
            {% endif %}
            {% if chef_final_pricing %}
            <a href="{{ url_for('customer_final_pricing', order_id=order.id) }}" 
               class="order-btn" 
               style="background: #28a745; color: white; text-decoration: none; font-weight: bold;">
                æŸ¥çœ‹æœ€çµ‚å®šåƒ¹
            </a>
            {% endif %}
            <button class="message-btn" onclick="openMessageBoard(this)">ç•™è¨€</button>
            <a href="{{ url_for('order_detail', order_id=order.id) }}" class="order-btn">æŸ¥çœ‹è©³ç´°è¨‚å–®è³‡è¨Š</a>
        </div>
    </div>
    {% endfor %}
</div>

<script src="/static/js/notification.js"></script>
<script>
// è¨‚å–®ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const orderCards = document.querySelectorAll('.order-card');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeé¡
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // ç‚ºç•¶å‰æŒ‰éˆ•åŠ ä¸Šactiveé¡
            this.classList.add('active');

            const filterStatus = this.getAttribute('data-status');

            orderCards.forEach(card => {
                const cardStatus = card.getAttribute('data-status');
                
                if (filterStatus === 'all' || cardStatus === filterStatus) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
});

function openMessageBoard(button) {
    // ç•™è¨€åŠŸèƒ½å¾…å¯¦ç¾
    alert('ç•™è¨€åŠŸèƒ½é–‹ç™¼ä¸­');
}
</script>

</body>
</html>
