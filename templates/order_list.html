<!DOCTYPE html>

<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的訂單</title>
    <link rel="stylesheet" href="/static/css/my-order.css" />
    <link rel="stylesheet" href="/static/css/notification.css" />
</head>
<body>
    <div class="navbar">
        <div class="site-name">味你而煮</div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            {% if user %}
            <a href="/customer/cooking_method">料理方式建議</a>
            <a href="{{ url_for('order_step0') }}">新增訂單</a>
            <a href="{{ url_for('customer_order_list') }}">我的訂單</a>
            <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
            {% else %}
            <a href="{{ url_for('index') }}">關於我們</a>
            <a href="{{ url_for('index') }}">料理方式建議</a>
            <a href="{{ url_for('index') }}">常見問題</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>

<br>
<div class="maintext">所有訂單</div>
<div class="filter-buttons">
    <button class="filter-btn active" data-status="all">全部</button>
    <button class="filter-btn" data-status="ongoing">進行中</button>
    <button class="filter-btn" data-status="completed">已完成</button>
    <button class="filter-btn" data-status="cancelled">已取消</button>
</div>
<div class="container">
    {% for order in orders %}
    <!-- 檢查是否有待回應的廚師最終定價 -->
    {% set chef_final_pricing = none %}
    {% for nego in order.negotiations %}
        {% if nego.proposed_by == 'chef' and nego.is_accepted is none %}
            {% set chef_final_pricing = nego %}
        {% endif %}
    {% endfor %}
    
    <div class="order-card" data-status="
        {%- if order.status.value in ['pending', 'negotiating', 'accepted', 'preparing', 'ready'] -%}ongoing
        {%- elif order.status.value == 'completed' -%}completed
        {%- elif order.status.value == 'cancelled' -%}cancelled
        {%- else -%}all
        {%- endif -%}">
        
        <!-- 最終定價待回應提醒 -->
        {% if chef_final_pricing %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
            <div style="color: #856404; font-weight: bold; font-size: 14px;">
                🔔 廚師已提供最終定價，請儘快回應！
            </div>
            <div style="color: #856404; font-size: 12px; margin-top: 5px;">
                最終定價：NT${{ chef_final_pricing.proposed_amount | int }}
            </div>
        </div>
        {% endif %}
        
        <div class="order-header">
            <span class="order-num"><strong>訂單編號 #{{ order.id }}</strong></span>
            <span class="order-status">
                <!-- Debug: 顯示原始狀態信息 -->
                <!-- 狀態對象: {{ order.status }}, 狀態值: {{ order.status.value }} -->
                <span class="status {{ order.status.value }}" style="background-color: #FF9800; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                    {% if order.status.value == 'pending' %}等待回應
                    {% elif order.status.value == 'negotiating' %}議價中
                    {% elif order.status.value == 'accepted' %}已接單
                    {% elif order.status.value == 'preparing' %}製作中
                    {% elif order.status.value == 'ready' %}製作完成
                    {% elif order.status.value == 'completed' %}交付完成
                    {% elif order.status.value == 'cancelled' %}已取消
                    {% elif order.status.value == 'reselecting_chef' %}重新選擇廚師
                    {% else %}{{ order.status.value }}
                    {% endif %}
                </span>
            </span>
        </div>
        <p>
            菜單列表：<br>
            {% for dish in order.dishes %}
                {{ loop.index }}. {{ dish.dish_name }}<br>
            {% endfor %}
        </p>
        <div class="button-group">
            {% if order.status.value == 'reselecting_chef' %}
            <a href="{{ url_for('reselect_chef', order_id=order.id) }}" 
               class="order-btn" 
               style="background: #ff6b35; color: white; text-decoration: none; font-weight: bold;">
                重新選擇廚師
            </a>
            {% endif %}
            {% if chef_final_pricing %}
            <a href="{{ url_for('customer_final_pricing', order_id=order.id) }}" 
               class="order-btn" 
               style="background: #28a745; color: white; text-decoration: none; font-weight: bold;">
                查看最終定價
            </a>
            {% endif %}
            <button class="message-btn" onclick="openMessageBoard(this)">留言</button>
            <a href="{{ url_for('order_detail', order_id=order.id) }}" class="order-btn">查看詳細訂單資訊</a>
        </div>
    </div>
    {% endfor %}
</div>

<script src="/static/js/notification.js"></script>
<script>
// 訂單狀態
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const orderCards = document.querySelectorAll('.order-card');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // 移除所有按鈕的active類
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // 為當前按鈕加上active類
            this.classList.add('active');

            const filterStatus = this.getAttribute('data-status');

            orderCards.forEach(card => {
                const cardStatus = card.getAttribute('data-status');
                
                if (filterStatus === 'all' || cardStatus === filterStatus) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
});

function openMessageBoard(button) {
    // 留言功能待實現
    alert('留言功能開發中');
}
</script>

</body>
</html>
