<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/imgs/favicon.ico">
    <title>待完成訂單 - 味你而煮</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/ChefUnOrder.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/notification.css') }}">
</head>
<body>
    <div class="navbar">
        <div class="site-name">
            <img src="/static/imgs/chef_logo.png" alt="Logo" class="site-logo">
            <div class="site-text">
                <div class="site-title">味你而煮</div>
                <div class="site-subtitle">cook for you</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('index') }}">首頁</a>
            {% if user %}
                {% if user.role and user.role.value == 'chef' %}
                <!-- 廚師專用導航 -->
                <a href="{{ url_for('chef_dashboard') }}">總覽</a>
                <a href="{{ url_for('chef_pending_orders') }}">待接單訂單</a>
                
                <!-- 廚師的我的訂單下拉選單 -->
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="dropdown-btn" onclick="toggleDropdown()" style="background: none; border: none; color: #B3811C; font-size: 18px; font-weight: bold; cursor: pointer; padding: 10px 20px; font-family: Arial, sans-serif; border-radius: 5px;">我的訂單 ▾</button>
                    <div class="dropdown-content" id="orderDropdown" style="display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; top: 100%;">
                        <a href="{{ url_for('chef_accepted_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">待完成訂單</a>
                        <a href="{{ url_for('chef_completed_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">已完成訂單</a>
                        <a href="{{ url_for('chef_negotiating_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">議價中訂單</a>
                        <a href="{{ url_for('chef_cancelled_orders') }}" style="color: #5B4636; padding: 12px 16px; text-decoration: none; display: block;" onmouseover="this.style.backgroundColor='#f1f1f1'" onmouseout="this.style.backgroundColor='white'">已取消訂單</a>
                    </div>
                </div>
                
                <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
                <a href="#">客服聯絡</a>
                {% else %}
                <!-- 顧客專用導航 -->
                <a href="/customer/cooking_method">料理方式建議</a>
                <a href="{{ url_for('order_step0') }}">新增訂單</a>
                <a href="{{ url_for('customer_order_list') }}">我的訂單</a>
                <a href="#" onclick="toggleNotification(); return false;">通知中心</a>
                {% endif %}
            {% else %}
            <a href="{{ url_for('index') }}">關於我們</a>
            <a href="{{ url_for('index') }}">料理方式建議</a>
            <a href="{{ url_for('index') }}">常見問題</a>
            {% endif %}
        </div>
        <div class="user-info">
            {% if user %}
            <img
                src="{{ avatar_url }}"
                alt="頭像"
                class="avatar"
            />
            <div class="user-text">
                <div class="name">{{ user.name }}</div>
                <div class="email">{{ user.email }}</div>
            </div>
            
            <div class="settings-icon" onclick="toggleSettingsModal()"></div>
            {% else %}
            <a href="{{ url_for('login') }}">登入/註冊</a>
            {% endif %}
        </div>
    </div>
    
    <div class="search-bar">
        <input type="text" placeholder="搜尋訂單" id="searchInput" onkeyup="searchOrders()">
    </div>
    
    <div class="title-filter-container">
        <div class="maintext">待完成訂單</div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterOrders('newest')">近到遠</button>
            <button class="filter-btn" onclick="filterOrders('oldest')">遠到近</button>
        </div>
    </div>
    
    <div class="container">
        {% if accepted_orders %}
            {% for order in accepted_orders %}
            <div class="order-card" data-date="{{ order.preferred_time.strftime('%Y/%m/%d') if order.preferred_time else '' }}">
                <p><strong>訂單編號</strong><br>#{{ order.order_number }}</p>
                <p>
                    預定日期：{{ order.preferred_time.strftime('%Y/%m/%d') if order.preferred_time else '未指定' }}<br>
                    地區：{{ order.delivery_address.split(' ')[0] if order.delivery_address else '未指定' }}<br>
                    地址：{{ order.delivery_address if order.delivery_address else '未指定' }}<br>
                    狀態：{{ order.status.value | replace('accepted', '已接單') | replace('preparing', '準備中') }}<br>
                    總金額：NT${{ order.total_amount | int if order.total_amount > 0 else '待議價' }}
                </p>
                <button class="order-btn" onclick="viewOrderDetail('{{ order.id }}')">查看訂單詳情</button>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-orders">
                <p>目前沒有待完成的訂單</p>
            </div>
        {% endif %}
    </div>

    <script>
        // 切換設定視窗
        function toggleSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function toggleDropdown() {
            var dropdown = document.getElementById("orderDropdown");
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
            } else {
                dropdown.style.display = "block";
            }
        }

        // 點擊其他地方時關閉下拉選單和設定視窗
        window.addEventListener('click', function(event) {
            // 關閉下拉選單
            if (!event.target.matches('.dropdown-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.style.display === "block") {
                        openDropdown.style.display = "none";
                    }
                }
            }
            
            // 關閉設定視窗
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
        });

        function viewOrderDetail(orderId) {
            window.location.href = `/chef/order/${orderId}`;
        }

        function searchOrders() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const cards = document.getElementsByClassName('order-card');
            
            for (let card of cards) {
                const text = card.textContent.toLowerCase();
                if (text.includes(filter)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            filterOrders('newest');
        });

        function filterOrders(type) {
            const container = document.querySelector('.container');
            const cards = Array.from(container.getElementsByClassName('order-card'));
            const filterButtons = document.querySelectorAll('.filter-btn');

            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (type === 'newest' ? '近到遠' : '遠到近')) {
                    btn.classList.add('active');
                }
            });

            const cardsWithDates = cards.map(card => {
                const dateStr = card.getAttribute('data-date');
                let timestamp = 0;
                if (dateStr) {
                    const [year, month, day] = dateStr.split('/');
                    timestamp = new Date(year, parseInt(month) - 1, day).getTime();
                }
                
                return {
                    element: card,
                    timestamp: timestamp
                };
            });

            cardsWithDates.sort((a, b) => {
                if (type === 'newest') {
                    return b.timestamp - a.timestamp;
                } else {
                    return a.timestamp - b.timestamp;
                }
            });

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            cardsWithDates.forEach(item => {
                container.appendChild(item.element);
            });
        }
    </script>

    <!-- 通知中心組件 -->
    {% include 'notification_component.html' %}
    
    <!-- 設定模態框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>帳戶設定</h3>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 帳號資訊區塊 -->
                <div class="account-section">
                    <div class="account-info-modern">
                        <img src="{{ current_user.avatar_url or url_for('static', path='imgs/avatar.png') }}" alt="Avatar" class="account-avatar">
                        <div class="account-details">
                            <div class="account-name">{{ current_user.name }}</div>
                            <div class="account-email">{{ current_user.email }}</div>
                        </div>
                    </div>
                    <div class="setting-item" onclick="showProfileEditor()">
                        <div class="setting-icon">👤</div>
                        <div class="setting-text">
                            <div class="setting-title">編輯個人資料</div>
                            <div class="setting-desc">修改姓名、頭像或密碼</div>
                        </div>
                        <div class="setting-arrow">→</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="setting-item" onclick="window.location.href='/auth/logout'">
                    <div class="setting-icon">🚪</div>
                    <div class="setting-text">
                        <div class="setting-title">登出</div>
                        <div class="setting-desc">登出目前帳戶</div>
                    </div>
                    <div class="setting-arrow">→</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 個人資料編輯模態框 -->
    {% include 'profile_editor_modal.html' %}

    <!-- 通知中心 JavaScript -->
    <script>
        // 通知系統變數
        let notifications = [];
        let unreadCount = 0;

        // 載入通知資料
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();
                if (result.success) {
                    notifications = result.data.notifications;
                    unreadCount = result.data.unread_count;
                } else {
                    console.error('載入通知失敗:', result.message);
                }
            } catch (error) {
                console.error('載入通知錯誤:', error);
            }
        }

        // 標記通知為已讀
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/mark_read`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('標記已讀失敗:', result.message);
                }
            } catch (error) {
                console.error('標記已讀錯誤:', error);
            }
        }

        // 清空所有通知
        async function clearAllNotifications() {
            try {
                const response = await fetch('/api/notifications/clear', {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    notifications = [];
                    unreadCount = 0;
                    updateNotifications();
                    updateNotificationStatus();
                } else {
                    console.error('清空通知失敗:', result.message);
                }
            } catch (error) {
                console.error('清空通知錯誤:', error);
            }
        }

        // 取得未讀通知數量
        async function getUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread_count');
                const result = await response.json();
                if (result.success) {
                    unreadCount = result.unread_count;
                    updateNotificationStatus();
                } else {
                    console.error('取得未讀數量失敗:', result.message);
                }
            } catch (error) {
                console.error('取得未讀數量錯誤:', error);
            }
        }

        // 切換通知中心顯示狀態
        async function toggleNotification() {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) {
                console.error('通知中心元素未找到');
                return;
            }
            
            if (notificationCenter.style.display === 'none' || !notificationCenter.style.display) {
                await loadNotifications();
                updateNotifications();
                notificationCenter.style.display = 'block';
            } else {
                notificationCenter.style.display = 'none';
            }
        }

        // 更新通知連結的狀態（未讀提示）
        function updateNotificationStatus() {
            const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
            if (!notificationLink) return;
            
            if (unreadCount > 0) {
                notificationLink.style.position = 'relative';
                notificationLink.innerHTML = `通知中心 <span style="position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;">${unreadCount}</span>`;
            } else {
                notificationLink.innerHTML = '通知中心';
            }
        }

        // 處理通知點擊跳轉
        function handleNotificationClick(notification) {
            let targetUrl = '';
            
            switch(notification.type) {
                case 'new_order':
                    // 新訂單 -> 待接單頁面
                    targetUrl = '/chef/pending-orders';
                    break;
                case 'order_completed':
                    // 訂單完成 -> 已完成訂單頁面
                    targetUrl = '/chef/completed-orders';
                    break;
                case 'new_review':
                    // 新評價 -> 廚師儀表板（查看評價）
                    targetUrl = '/chef/';
                    break;
                case 'negotiation_response':
                    // 議價回應 -> 議價中訂單頁面
                    targetUrl = '/chef/negotiating-orders';
                    break;
                case 'order_accepted':
                case 'order_rejected':
                case 'order_ready':
                    // 訂單狀態更新 -> 對應的訂單詳情
                    if (notification.order_id) {
                        targetUrl = `/chef/order/${notification.order_id}`;
                    }
                    break;
                default:
                    // 預設跳轉到儀表板
                    targetUrl = '/chef/';
                    break;
            }
            
            if (targetUrl) {
                // 關閉通知中心
                const notificationCenter = document.getElementById('notificationCenter');
                if (notificationCenter) {
                    notificationCenter.style.display = 'none';
                }
                // 跳轉頁面
                window.location.href = targetUrl;
            }
        }

        // 更新通知列表顯示
        function updateNotifications() {
            const notificationList = document.getElementById('notificationList');
            if (!notificationList) return;

            notificationList.innerHTML = '';

            if (notifications.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暫無通知</div>';
                notificationList.appendChild(li);
                return;
            }

            notifications.forEach((notification) => {
                const li = document.createElement('li');
                li.className = 'notification-item';
                if (!notification.is_read) {
                    li.classList.add('unread');
                }

                // 通知類型圖標
                const typeIcon = {
                    'new_order': '📋',
                    'order_completed': '✅',
                    'new_review': '⭐',
                    'negotiation_response': '💬',
                    'order_accepted': '✅',
                    'order_rejected': '❌',
                    'order_ready': '🍽️',
                    'review_reply': '💬'
                };
                const icon = typeIcon[notification.type] || '📢';

                // 判斷是否為訂單類通知，如果是則顯示訂單編號
                const orderTypes = ['order_accepted', 'order_rejected', 'order_status_update', 'order_ready', 'order_completed', 'new_order', 'order_negotiation', 'negotiation_response'];
                const isOrderNotification = orderTypes.includes(notification.type);
                const orderInfo = isOrderNotification && notification.order_id ? `<span style="color: #007bff; font-size: 12px;">#${notification.order_id}</span> ` : '';
                
                li.innerHTML = `
                    <div class="notification-type type-${notification.type.replace('_', '-')}">${icon}</div>
                    <div class="notification-content">
                        <div style="font-weight: ${!notification.is_read ? 'bold' : 'normal'};">${orderInfo}${notification.title}</div>
                        <div style="margin-top: 4px; font-size: 14px; color: #666;">${notification.content}</div>
                        <div class="notification-time">${notification.time_ago}</div>
                    </div>
                `;
                
                li.addEventListener('click', async () => {
                    if (!notification.is_read) {
                        await markNotificationAsRead(notification.id);
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        li.classList.remove('unread');
                        li.querySelector('.notification-content > div').style.fontWeight = 'normal';
                        updateNotificationStatus();
                    }
                    
                    // 根據通知類型跳轉到對應頁面
                    handleNotificationClick(notification);
                });

                notificationList.appendChild(li);
            });
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await getUnreadCount();
            
            document.addEventListener('click', function(e) {
                const notificationCenter = document.getElementById('notificationCenter');
                const notificationLink = document.querySelector('a[onclick*="toggleNotification"]');
                
                if (notificationCenter && notificationLink && 
                    !notificationCenter.contains(e.target) && !notificationLink.contains(e.target)) {
                    notificationCenter.style.display = 'none';
                }
            });
        });

        // 定期更新未讀通知數量
        setInterval(getUnreadCount, 30000); // 每30秒更新一次
    </script>
</body>
</html> 